<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="robots" content="noindex, nofollow">
<title>Admin</title>

  <style>
    :root{
      font-size:12.5px;
      --btn-angle:135deg;

      /* match your active-page reds (Rankings/Matchups) */
      --red1:#ff3b3b;
      --red2:#e40000;
    }

    html, body{
      margin:0; padding:0;
      background:#f7f8fa; color:#222;
      font-family:"Segoe UI", Roboto, Arial, sans-serif;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }
    body { padding: 10px;
      padding-bottom: calc(190px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    /* panels */
    .panel{
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:14px;
      margin:12px 0;
    }

    /* red header like active pages */
    .panel-titlebar{
      display:flex;
      align-items:center;
      justify-content:center;

      /* span edge-to-edge inside .panel (which has padding:14px) */
      margin:-14px -14px 10px;
      padding:14px;

      text-transform:uppercase;
      font-weight:950;
      font-size:14px;
      letter-spacing:.02em;
      user-select:none;

      color:#fff;
      background: linear-gradient(var(--btn-angle), var(--red1, #e11d48) 0%, var(--red2, #b91c1c) 100%);
      border-radius:18px 18px 0 0;
    }

    .h2{ font-size:14px; font-weight:900; margin:0 0 10px; text-transform:uppercase; text-align:center; }
    .muted{ color:#667085; font-size:12px; }
    
    .toggleRow{ display:flex; align-items:center; gap:10px; font-weight:900; }
    .toggleRow input{ width:18px; height:18px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .field{ flex:1 1 160px; min-width:160px; }
    label{ display:block; font-weight:800; font-size:11px; text-transform:uppercase; color:#667085; margin:0 0 6px; }
    input, select{
      width:100%;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
      box-sizing:border-box;
    }
    input:focus, select:focus{ border-color:#f43f5e; box-shadow:0 0 0 3px rgba(244,63,94,.15); }

    .btn{
      border:0;
      border-radius:14px;
      padding:10px 14px;
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.02em;
      cursor:pointer;
      background: linear-gradient(var(--btn-angle), var(--red1, #e11d48) 0%, var(--red2, #b91c1c) 100%);
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.secondary{
      background:#111827;
    }
    .btn.ghost{
      background:#fff;
      border:1px solid #e5e7eb;
      color:#111827;
      box-shadow:none;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .toolbar-left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toggle{
      display:flex; align-items:center; gap:8px;
      user-select:none;
      font-weight:800;
      color:#667085;
      text-transform:uppercase;
      font-size:11px;
    }
    .toggle input{ width:auto; }

    /* table (match Stats) */
    .table-wrap{ overflow-x:hidden; }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    thead th{
      font-size:11px;
      letter-spacing:.06em;
      color:#4b5563;
      padding:10px 10px;
      border-bottom:1px solid #eef2f7;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform:uppercase;
      text-align:center;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid #f1f5f9;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody td:first-child{ text-align:left; }
    thead th:nth-child(n+2),
    tbody td:nth-child(n+2){ text-align:center; }

.actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.02em;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#111827;
    }
    .pill.off{ background:#fff1f2; border-color:#fecdd3; color:#9f1239; }
    .pill.on{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }

    .toast{
      position:fixed;
      left:12px; right:12px;
      bottom:calc(12px + env(safe-area-inset-bottom));
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
      display:none;
      z-index:9999;
      font-weight:800;
      font-size:12px;
    }

    @media (min-width: 840px){
      body{ max-width:980px; margin:0 auto; }
    }
  
/* bottom action bar */
.bottom-bar{
  position:fixed;
  left:0; right:0; bottom:0;
  padding:10px 12px calc(12px + env(safe-area-inset-bottom));
  background: rgba(247,248,250,.92);
  backdrop-filter: blur(10px);
  border-top:1px solid #eef2f7;
  z-index: 999;
}
.bottom-inner{
  max-width:980px;
  margin:0 auto;
  display:flex;
  gap:10px;
}
.btn-blue, .btn-gray{
  flex:1;
  border:0;
  border-radius:16px;
  padding:14px 12px;
  font-weight:950;
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:.02em;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
}
.btn-blue{
  color:#fff;
  background: linear-gradient(var(--btn-angle), #2f6fff, #1557ff);
}
.btn-gray{
  color:#fff;
  background: linear-gradient(var(--btn-angle), #9aa4b2, #667085);
}
/* modal */
.modal{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.4);
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding: 18px 12px;
  z-index: 2000;
}
.modal.show{ display:flex; }
.modal-card{
  width:100%;
  max-width: 720px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.35);
  overflow:hidden;
}
.modal-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 14px 12px;
  border-bottom:1px solid #eef2f7;
}
.modal-head .title{
  font-weight:950;
  letter-spacing:.02em;
  text-transform:uppercase;
  font-size:14px;
}
.icon-btn{
  border:0;
  background:transparent;
  width:38px;
  height:38px;
  border-radius:12px;
  font-size:26px;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
.form-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  padding:14px;
}
@media (max-width:520px){
  .form-grid{ grid-template-columns: 1fr; }
}
.btn-row{
  display:flex;
  gap:10px;
  padding:14px;
  border-top:1px solid #eef2f7;
}

/* ==== Admin table mobile tighten ==== */
#playersTable{ table-layout: fixed; }
#playersTable th, #playersTable td{ padding: 8px 8px; }

#playersTable th:nth-child(1), #playersTable td:nth-child(1){ width: 34%; text-align:left; }
#playersTable th:nth-child(2), #playersTable td:nth-child(2){ width: 12%; }
#playersTable th:nth-child(3), #playersTable td:nth-child(3){ width: 14%; } /* status */
#playersTable th:nth-child(4), #playersTable td:nth-child(4){ width: 10%; }
#playersTable th:nth-child(5), #playersTable td:nth-child(5){ width: 12%; }
#playersTable th:nth-child(6), #playersTable td:nth-child(6){ width: 18%; }

#playersTable .actions{ justify-content:flex-end; gap:6px; }
#playersTable .actions .btn{
  padding: 8px 10px;
  border-radius: 12px;
  font-size: 11px;
  line-height: 1;
  box-shadow: none;
}

/* On phones: hide Status column, give Name more room */
@media (max-width: 520px){
  #playersTable th:nth-child(3),
  #playersTable td:nth-child(3){ display:none; } /* hide status */

  #playersTable th:nth-child(1), #playersTable td:nth-child(1){ width: 46%; }
  #playersTable th:nth-child(2), #playersTable td:nth-child(2){ width: 14%; }
  #playersTable th:nth-child(4), #playersTable td:nth-child(4){ width: 10%; }
  #playersTable th:nth-child(5), #playersTable td:nth-child(5){ width: 12%; }
  #playersTable th:nth-child(6), #playersTable td:nth-child(6){ width: 18%; }

  /* Keep actions from wrapping too tall */
  #playersTable td:nth-child(6) .actions{ flex-wrap: nowrap; }
}
/* name + pill layout */
.nameCell{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
.nameCell .nm{
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* base widths for 4-column table */
#playersTable th:nth-child(1), #playersTable td:nth-child(1){ width: 58%; }
#playersTable th:nth-child(2), #playersTable td:nth-child(2){ width: 10%; text-align:center; }
#playersTable th:nth-child(3), #playersTable td:nth-child(3){ width: 12%; text-align:center; }
#playersTable th:nth-child(4), #playersTable td:nth-child(4){ width: 20%; }

/* actions stay compact */
#playersTable .actions{ justify-content:flex-end; gap:6px; }
#playersTable .actions .btn{
  padding: 7px 10px;
  border-radius: 12px;
  font-size: 11px;
  line-height: 1;
  box-shadow: none;
  white-space: nowrap;
}

/* phone tuning */
@media (max-width: 520px){
  th, td{ padding: 9px 8px; font-size: 12px; }
  #playersTable .actions{ flex-wrap:nowrap; }
  #playersTable .actions .btn{ padding: 7px 9px; font-size: 10.5px; }
  .pill{ padding: 3px 7px; font-size: 9px; }
}

</style>
</head>

<body data-build="admin-v7">
<style>
:root{ --fa-header-offset: 0px; }

/* Header container */
.fa-header{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #f7f8fa;
  border-bottom: none;
  padding: 0 !important;
  box-sizing: border-box;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* ✅ Help block pinch/zoom gestures inside iframe (browser-dependent) */
html, body { touch-action: pan-x pan-y; }

/* ============ TOP TABS (4) ============ */
.fa-header .fa-tabs{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px !important;
  padding: 8px 0 !important;
  margin: 0 !important;
  border: none !important;
  background: transparent !important;
  border-radius: 0 !important;
}

/* Shared button base for top tabs + submenu buttons */
.fa-header .fa-tabs button,
.fa-header .fa-submenu button{
  -webkit-appearance:none !important;
  appearance:none !important;

  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  width:100% !important;
  box-sizing:border-box !important;

  font-family:"Segoe UI", Roboto, Arial, sans-serif !important;
  font-weight:900 !important;
  font-size: clamp(12px, 3.6vw, 16px) !important;
  letter-spacing: .2px !important;
  line-height: 1 !important;

  height: 40px !important;
  min-height: 40px !important;
  padding: 0 6px !important;

  border-radius: 8px !important;
  border: 0 !important;
  outline: none !important;

  background: linear-gradient(180deg, #f9f9f9 0%, #ededed 100%) !important;
  box-shadow: 0 1px 4px rgba(0,0,0,.10) !important;

  color: #222 !important;
  cursor: pointer !important;

  transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease, filter .12s ease !important;

  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;

  -webkit-tap-highlight-color: transparent !important;
  user-select: none !important;
}

.fa-header .fa-tabs button:not(.active):hover,
.fa-header .fa-submenu button:not(.sub-active):hover{
  background: linear-gradient(180deg, #f1f1f1 0%, #e3e7f0 100%) !important;
}

/* Active tab */
.fa-header .fa-tabs button.active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

/* Tap flash */
.fa-header .fa-tabs button.fa-press,
.fa-header .fa-submenu button.fa-press{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

.fa-header .fa-tabs button:active,
.fa-header .fa-submenu button:active{
  transform: scale(0.99);
}

/* ======= Hamburger button + logo ======= */
#nav-menu{
  padding: 0 10px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
}

#nav-menu .menu-logo{
  height: 18px;
  width: auto;
  display: block;
}

#nav-menu .hamburger-icon{
  width: 24px;
  height: 24px;
  flex: 0 0 auto;
}
#nav-menu .hamburger-icon{
  width: 24px;
  height: 24px;
  flex: 0 0 auto;
}

/* ============ DROPDOWN MENU (hamburger) ============ */
.fa-submenu-wrap{ position: relative; }

.fa-submenu{
  position: absolute;
  top: 100%;
  left: 0;
  padding: 8px 0 0;
  z-index: 1001;

  opacity: 0;
  transform: translateY(-6px);
  visibility: hidden;
  pointer-events: none;
  transition: opacity 140ms ease, transform 140ms ease, visibility 0s linear 140ms;
}
.fa-submenu.show{
  opacity: 1;
  transform: translateY(0);
  visibility: visible;
  pointer-events: auto;
  transition: opacity 140ms ease, transform 140ms ease;
}

.fa-submenu .inner{
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 12px 26px rgba(0,0,0,.16);
  border-radius: 14px;
  overflow: hidden;
  padding: 8px;

  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;

  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

/* Slightly taller menu rows feels more “iOS” without changing your top tabs */
.fa-header .fa-submenu button{
  height: 42px !important;
  min-height: 42px !important;
  font-size: 13px !important;
  border-radius: 12px !important;
}

.fa-header .fa-submenu button.sub-active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color:#fff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.04);
}

@media (max-width: 420px){
  .fa-header .fa-tabs{ padding: 6px 0 !important; }
  .fa-header .fa-tabs button{
    height: 36px !important;
    min-height: 36px !important;
    font-size: 13px !important;
    padding: 0 6px !important;
  }
  .fa-header .fa-submenu button{
    height: 40px !important;
    min-height: 40px !important;
    font-size: 12.5px !important;
  }
  #nav-menu .hamburger-icon{
    width: 22px;
    height: 22px;
  }
}
@media (max-width: 420px){
  #nav-menu .menu-logo{ height: 16px; }
  #nav-menu .hamburger-icon{ width: 22px; height: 22px; }
}
/* =========================================================
   Pull-to-refresh toast (spinner-only pill)
   ========================================================= */
#fa-ptr{
  position: fixed;
  left: 50%;
  top: calc(env(safe-area-inset-top) + 10px);
  transform: translate(-50%, -14px);
  opacity: 0;
  z-index: 99999;
  pointer-events: none;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  padding: 10px 12px;
  border-radius: 999px;

  background: rgba(255,255,255,.92);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 18px rgba(0,0,0,.12);

  transition: opacity 140ms ease, transform 140ms ease;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
#fa-ptr.show{ opacity: 1; transform: translate(-50%, 0); }
#fa-ptr .spin{
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,.18);
  border-top-color: rgba(0,0,0,.55);
  animation: faSpin 800ms linear infinite;
}
@keyframes faSpin { to { transform: rotate(360deg); } }
</style>

<div class="fa-header fa-submenu-wrap">
<nav class="fa-tabs">
<button data-page="scoring" id="nav-scoring" type="button">SCORING</button>
<button data-page="rosters" id="nav-rosters" type="button">ROSTERS</button>
<button data-page="matchups" id="nav-matchups" type="button">MATCHUPS</button>
<!-- Hamburger -->
<button aria-expanded="false" aria-label="More" data-key="menu" id="nav-menu" type="button">
<img alt="" aria-hidden="true" class="menu-logo" decoding="async" loading="eager" src="https://lufberydiscgolf.com/wp-content/uploads/2025/05/lufberyflyingace_logo-1.png?w=64&amp;h=32"/>
<svg aria-hidden="true" class="hamburger-icon" viewbox="0 0 24 24">
<path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2.6"></path>
</svg>
</button>
</nav>
<!-- Dropdown (anchored under hamburger) -->
<div aria-hidden="true" class="fa-submenu" id="faMoreMenu">
<div class="inner">
<button data-page="rankings">RANKINGS</button>
<button data-page="stats">STATS</button>
<button data-page="elo">ELO</button>
<button data-page="standings">STANDINGS</button>
<button data-page="admin">ADMIN</button>
</div>
</div>
</div>
<script>
/* ===========================
   0) Disable pinch/zoom inside iframe (iOS Safari fallback)
   =========================== */
(function(){
  ['gesturestart','gesturechange','gestureend'].forEach(function(evt){
    document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive:false });
  });

  var lastTouchEnd = 0;

  function _faIsIOS_(){
    try{
      var ua = navigator.userAgent || "";
      var plat = navigator.platform || "";
      var isIPhoneIPadIPod = /iPad|iPhone|iPod/.test(ua);
      var isIPadOS = (plat === "MacIntel" && (navigator.maxTouchPoints || 0) > 1);
      return isIPhoneIPadIPod || isIPadOS;
    }catch(_){ return false; }
  }
  function _faIsInteractive_(t){
    try{
      return !!(t && t.closest && t.closest("button,a,input,select,textarea,label,[role='button'],[contenteditable='true']"));
    }catch(_){ return false; }
  }

  document.addEventListener('touchend', function(e){
    if (!_faIsIOS_()) return;
    if (_faIsInteractive_(e.target)) return;

    var now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, { passive:false });
})();

/* ===========================
   1) Header nav + menu + active state
   =========================== */
(function(){
  function qs() {
    try { return new URLSearchParams(window.location.search || ""); }
    catch (e) { return new URLSearchParams(""); }
  }

  function currentPage(){
    var p = (qs().get("p") || qs().get("page") || "").toLowerCase();

    // Support hash routing (GitHub wrapper uses #scoring, #matchups, etc.)
    if (!p){
      var h = (window.location.hash || "").replace(/^#/, "").toLowerCase();
      h = h.replace(/^\/+/, "");
      if (h.indexOf("?") !== -1) h = h.split("?")[0];
      if (h.indexOf("&") !== -1) h = h.split("&")[0];
      p = h;
    }

    // Support clean-path routing (/rosters, /matchups, etc.)
    if (!p){
      var path = (window.location.pathname || "").toLowerCase();
      path = path.replace(/\/+$/, ""); // trim trailing slash
      if (path && path !== "/"){
        var seg = path.split("/").filter(Boolean).pop() || "";
        seg = seg.replace(/\.html$/, "");
        p = seg;
      }
    }

    if (!p) return "matchups";
    if (p === "doubles") p = "rosters";
    return p;
  }

  function isEmbedded(){
    try { if (window.top !== window) return true; } catch(e){ return true; }
    return false;
  }

  // Pages that live under the hamburger menu
  const menuPages = ['rankings','stats','standings','elo','admin','players'];

  function setActiveByPage(page){
    page = String(page||"").toLowerCase();

    // top tabs
    document.querySelectorAll(".fa-tabs button").forEach(function(b){
      var key = b.dataset.key || b.dataset.page || "";
      var active = false;
      if (key === "menu") active = (menuPages.indexOf(page) !== -1);
      else active = (b.dataset.page === page);
      b.classList.toggle("active", !!active);
    });

    // dropdown buttons
    var menu = document.getElementById("faMoreMenu");
    if (menu){
      menu.querySelectorAll("button[data-page]").forEach(function(btn){
        btn.classList.toggle("sub-active", (btn.dataset.page === page));
      });
    }
  }

  function detectActive(){
    try{
      var p = currentPage();
      if (menuPages.indexOf(p) !== -1 || ["scoring","rosters","matchups"].indexOf(p) !== -1){
        setActiveByPage(p);
        return;
      }
      
      // STATS title marker (helps when Stats page also contains roster/link sections)
      var titleBar = document.querySelector(".pageTitlePanel .panel-titlebar, .panel.pageTitlePanel .panel-titlebar, .panel-titlebar");
      if (titleBar && /stats/i.test((titleBar.textContent || "").trim())){
        setActiveByPage("stats");
        return;
      }

// ELO markers
      if (
        document.getElementById("kBase") ||
        document.getElementById("overallBody") ||
        document.getElementById("pairsBody") ||
        /(^|\s)elo(\s|$)/i.test(document.title || "")
      ){
        setActiveByPage("elo");
        return;
      }

      // DOM heuristics
      if (document.getElementById("singlesBody") || document.getElementById("recentCards")) { setActiveByPage("stats"); return; }
      if (document.getElementById("table-body")) { setActiveByPage("rankings"); return; }
      if (document.getElementById("b1") || document.getElementById("b2") || document.getElementById("b9")) { setActiveByPage("scoring"); return; }
      if (document.getElementById("panel-CURRENT")) { setActiveByPage("rosters"); return; }
      if (document.getElementById("playersTable") || document.getElementById("teamSelect")) { setActiveByPage("admin"); return; }
      if (document.getElementById("team1Table") || document.getElementById("team2Table")) { setActiveByPage("matchups"); return; }
      // Standings markers
      if (document.getElementById("matchResults") || document.getElementById("adjWrap") || document.getElementById("simMatchup")) { setActiveByPage("standings"); return; }

      // title fallback
      var t = (document.title || "").toLowerCase();
      if (t.indexOf("stat") !== -1) { setActiveByPage("stats"); return; }
      if (t.indexOf("ranking") !== -1) { setActiveByPage("rankings"); return; }
      if (t.indexOf("scor") !== -1) { setActiveByPage("scoring"); return; }
      if (t.indexOf("roster") !== -1 || t.indexOf("double") !== -1) { setActiveByPage("rosters"); return; }

      setActiveByPage("matchups");
    }catch(e){
      setActiveByPage("matchups");
    }
  }

  function extraQS(opts){
    opts = opts || {};
    var s = qs();
    var parts = [];
    // Only propagate embed=1 when actually inside an iframe
    if (opts.embed && isEmbedded()) parts.push("embed=1");
    var scale = s.get("scale");
    var v = s.get("v");
    if (scale) parts.push("scale=" + encodeURIComponent(scale));
    if (v) parts.push("v=" + encodeURIComponent(v));
    return parts.length ? ("?" + parts.join("&")) : "";
  }

  function buildHref(page){
    page = String(page||"").toLowerCase();
    if (!page) return "";
    if (isEmbedded()){
      var q = extraQS({ embed:true });
      if (q) q = q.replace(/^\?/, "&");
      return "?p=" + encodeURIComponent(page) + q;
    } else {
      return "/" + encodeURIComponent(page) + ".html" + extraQS({ embed:false });
    }
  }

  function maybeRedirectLegacyParams(){
    if (isEmbedded()) return;
    var s = qs();
    var p = (s.get("p") || s.get("page") || "").toLowerCase();
    if (!p) return;

    var target = "/" + encodeURIComponent(p) + ".html";
    var cur = (window.location.pathname || "").toLowerCase().replace(/\/+/g, "/");
    if (cur.endsWith("/")) cur = cur.slice(0, -1);
    if (cur === target.toLowerCase()) return;

    var q2 = extraQS({ embed:false });
    try{
      window.location.replace(q2 ? (target + q2) : target);
    }catch(e){
      window.location.href = q2 ? (target + q2) : target;
    }
  }

  

  function sendToWrapper(page){
    var msg = { type: "FA_NAV", page: page };
    var sent = false;
    try { window.top.postMessage(msg, "*"); sent = true; } catch(e){}
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(msg, "*");
        sent = true;
      }
    } catch(e){}
    return sent;
  }

  // ---- menu open/close ----
  var menuBtn  = document.getElementById("nav-menu");
  var menuEl   = document.getElementById("faMoreMenu");

  function setMenuAria(open){
    if (!menuBtn) return;
    menuBtn.setAttribute("aria-expanded", open ? "true" : "false");
  }

  function positionMenu(){
    if (!menuEl || !menuBtn) return;
    var wrap = document.querySelector(".fa-submenu-wrap");
    if (!wrap) return;

    var wrapRect = wrap.getBoundingClientRect();
    var btnRect  = menuBtn.getBoundingClientRect();

    // Wider than the button for a “real site” menu feel
    var width = Math.max(btnRect.width + 12, 200);
    width = Math.min(width, Math.floor(wrapRect.width - 8));

    // Right-align under the hamburger (more typical)
    var left = (btnRect.right - wrapRect.left) - width;

    // Clamp within wrap bounds
    var maxLeft = Math.max(0, wrapRect.width - width);
    left = Math.max(0, Math.min(left, maxLeft));

    menuEl.style.left = left + "px";
    menuEl.style.right = "auto";
    menuEl.style.width = width + "px";
  }

  function openMenu(){
    if (!menuEl) return;
    positionMenu();
    menuEl.classList.add("show");
    menuEl.setAttribute("aria-hidden","false");
    setMenuAria(true);
  }

  function closeMenu(){
    if (!menuEl) return;
    menuEl.classList.remove("show");
    menuEl.setAttribute("aria-hidden","true");
    setMenuAria(false);
  }

  function toggleMenu(){
    if (!menuEl) return;
    if (menuEl.classList.contains("show")) closeMenu();
    else openMenu();
  }

  function navigate(page){
    page = String(page||"").toLowerCase();
    if (!page) return;

    closeMenu();

    // Active immediately so tap feels responsive
    setActiveByPage(page);

    var embedded = isEmbedded();
    if (embedded){
      var ok = sendToWrapper(page);
      if (!ok) window.location.href = buildHref(page);
    }else{
      window.location.href = buildHref(page);
    }
  }

  // Close on outside click
  document.addEventListener("click", function(e){
    if (!menuEl || !menuEl.classList.contains("show")) return;
    var t = e.target;
    if (t === menuBtn || (menuBtn && menuBtn.contains(t))) return;
    if (menuEl.contains(t)) return;
    closeMenu();
  }, true);

  // Keep menu anchored on resize/orientation changes
  window.addEventListener("resize", function(){
    if (menuEl && menuEl.classList.contains("show")) positionMenu();
  }, { passive:true });

  // ESC closes
  document.addEventListener("keydown", function(e){
    if (e.key === "Escape") closeMenu();
  });

  // Tap flash
  function flash(btn){
    if (!btn) return;
    btn.classList.add("fa-press");
    window.setTimeout(function(){ btn.classList.remove("fa-press"); }, 140);
  }
  function wireFlash(root){
    if (!root) return;
    root.querySelectorAll("button").forEach(function(btn){
      btn.addEventListener("touchstart", function(){ flash(btn); }, { passive:true });
      btn.addEventListener("mousedown",  function(){ flash(btn); }, { passive:true });
    });
  }
  wireFlash(document.querySelector(".fa-tabs"));
  wireFlash(menuEl);

  // Wire top tabs
  document.querySelectorAll(".fa-tabs button").forEach(function(btn){
    btn.addEventListener("click", function(){
      if (btn.id === "nav-menu"){ toggleMenu(); return; }
      var page = btn.dataset.page;
      if (page) navigate(page);
    });
  });

  // Wire dropdown
  if (menuEl){
    menuEl.querySelectorAll("button[data-page]").forEach(function(btn){
      btn.addEventListener("click", function(){
        navigate(btn.dataset.page);
      });
    });
  }

  // Expose helpers
  try { window.faNavigate = navigate; } catch(e){}
  try { window.navigate = navigate; } catch(e){}
  try { window.faSetActiveByPage = setActiveByPage; } catch(e){}
  try { window.faDetectActive = detectActive; } catch(e){}

  // Keep active tab in sync for hash-routed / SPA navigation
  window.addEventListener("hashchange", function(){ setTimeout(detectActive, 0); }, { passive:true });
  window.addEventListener("popstate",  function(){ setTimeout(detectActive, 0); }, { passive:true });
  try{
    ["pushState","replaceState"].forEach(function(fn){
      var orig = history[fn];
      if (!orig) return;
      history[fn] = function(){
        var r = orig.apply(this, arguments);
        setTimeout(detectActive, 0);
        return r;
      };
    });
  }catch(_){ }

  maybeRedirectLegacyParams();
  detectActive();
  setMenuAria(false);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(detectActive, 0); });
  } else {
    setTimeout(detectActive, 0);
  }
})();

/* ===========================
   2) Pull-to-refresh (unchanged)
   =========================== */
(function(){
  function isEmbedded(){
    try { return window.top !== window; } catch(e){ return true; }
  }

  function scrollTop(){
    var se = document.scrollingElement || document.documentElement || document.body;
    return se ? (se.scrollTop || 0) : 0;
  }

  function headerBottom(){
    var h = document.querySelector(".fa-header");
    if (!h) return 0;
    var r = h.getBoundingClientRect();
    return r ? (r.bottom || r.height || 0) : 0;
  }

  function isInteractiveTarget(el){
    if (!el) return false;
    return !!el.closest("button,a,input,select,textarea,label,[role='button'],[contenteditable='true'],[data-no-ptr]");
  }

  function _isVisible_(el){
    try{
      if (!el) return false;
      var cs = getComputedStyle(el);
      if (cs.display === "none" || cs.visibility === "hidden") return false;
      if (parseFloat(cs.opacity || "1") === 0) return false;
      var r = el.getBoundingClientRect();
      return !!(r && r.width > 0 && r.height > 0);
    }catch(_){ return false; }
  }

  function inModalOrOverlay(el){
    try{
      return !!(el && el.closest && el.closest(
        "[data-no-ptr],[aria-modal='true'],[role='dialog'],[role='alertdialog'],dialog,.modal,.dialog,.overlay"
      ));
    }catch(_){ return false; }
  }

  function isModalOpen(){
    try{
      if (document.body && document.body.classList && document.body.classList.contains("modal-open")) return true;

      // Any visible dialog/modal/overlay element that is positioned above content
      var nodes = document.querySelectorAll("[aria-modal='true'],dialog[open],[role='dialog'],[role='alertdialog'],.modal,.dialog,.overlay");
      for (var i=0; i<nodes.length; i++){
        var n = nodes[i];
        if (!n || (n.classList && n.classList.contains("fa-header"))) continue;
        if (!_isVisible_(n)) continue;
        var cs = getComputedStyle(n);
        if (cs.position === "fixed" || cs.position === "absolute") return true;
      }
    }catch(_){}
    return false;
  }

  var toast;

  function ensureToast(){
    if (toast) return true;
    if (!document.body) return false;
    toast = document.createElement("div");
    toast.id = "fa-ptr";
    toast.innerHTML = '<span class="spin"></span>';
    document.body.appendChild(toast);
    return true;
  }

  function showToast(){
    if (!ensureToast()) return;
    toast.classList.add("show");
  }

  function hideToast(){
    if (!toast) return;
    toast.classList.remove("show");
  }

  function postRefresh(nonce){
    var msg = { type: "FA_REFRESH", nonce: nonce };
    try { window.top.postMessage(msg, "*"); } catch(e){}
    try {
      if (window.parent && window.parent !== window) window.parent.postMessage(msg, "*");
    } catch(e){}
  }

  function hardReloadSelf(){
    try {
      var u = new URL(location.href);
      u.searchParams.set("r", String(Date.now()));
      u.searchParams.set("fresh", "1");
      location.replace(u.toString());
    } catch(e) {
      location.reload();
    }
  }

  function requestRefresh(){
    var nonce = Date.now();
    var didUnload = false;
    window.addEventListener("beforeunload", function(){ didUnload = true; }, { once:true });

    if (isEmbedded()) postRefresh(nonce);
    else hardReloadSelf();

    setTimeout(function(){
      if (!didUnload) hardReloadSelf();
    }, 350);
  }

  var startY = 0, startX = 0, lastDy = 0;
  var armed = false;

  // Make accidental refreshes harder, but still easy enough when intentional
  var THRESH = 120;   // was 90
  var SHOW_AT = 18;   // was 12
  var MAX_SLOP_X = 80;
  var VERTICAL_RATIO = 2.0;

  window.addEventListener("touchstart", function(e){
    if (!e.touches || e.touches.length !== 1) { armed = false; return; }

    // Only arm when the MAIN page is truly at the top
    if (scrollTop() > 0) { armed = false; return; }

    // Never arm while a modal/overlay is open (prevents modal-top bounce triggering refresh)
    if (isModalOpen() || inModalOrOverlay(e.target)) { armed = false; return; }

    // Never arm on buttons/inputs/explicit no-ptr zones
    if (isInteractiveTarget(e.target)) { armed = false; return; }

    var t = e.touches[0];
    startY = t.clientY;
    startX = t.clientX;
    lastDy = 0;

    // Allow pull-to-refresh starting anywhere below the sticky header
    armed = (startY >= (headerBottom() + 6));
  }, { passive:true });

  window.addEventListener("touchmove", function(e){
    if (!armed || !e.touches || e.touches.length !== 1) return;

    var t = e.touches[0];
    var dy = t.clientY - startY;
    var dx = t.clientX - startX;

    if (dy <= 0){
      lastDy = 0;
      hideToast();
      return;
    }

    var adx = Math.abs(dx);
    if (adx > MAX_SLOP_X || dy < adx * VERTICAL_RATIO){
      lastDy = 0;
      hideToast();
      return;
    }

    if (dy > SHOW_AT){
      lastDy = dy;
      showToast();
    }
  }, { passive:true });

  window.addEventListener("touchend", function(){
    if (!armed){ hideToast(); return; }

    if (lastDy >= THRESH){
      showToast();
      setTimeout(requestRefresh, 60);
    } else {
      hideToast();
    }

    armed = false;
    lastDy = 0;
  }, { passive:true });

  window.addEventListener("touchcancel", function(){
    armed = false;
    lastDy = 0;
    hideToast();
  }, { passive:true });
})();
</script>
<script>
(function(){
  try{
    var path = (window.location.pathname || "").toLowerCase();
    var file = path.split("/").pop() || "";
    var page = "";
    if (file.endsWith(".html")) page = file.slice(0, -5);
    if (!page){
      // if served as /page (without .html), try first segment
      var seg = path.split("/").filter(Boolean)[0] || "";
      page = seg;
    }
    if (page && window.faSetActiveByPage) window.faSetActiveByPage(page);
  }catch(_){}
})();
</script>



<script>
/* =========================
   google.script.run → fetch() bridge (Native Fetch Polyfill)
   - Set window.GAS_API_URL once (or store FA_GAS_API_URL in localStorage)
   ========================= */
(function(){
  const GAS_API_URL = window.GAS_API_URL || localStorage.getItem("FA_GAS_API_URL") || "https://script.google.com/macros/s/AKfycbxlyif58qdt0l90lSvHOm0TxlPffdfMqajwzhGDQlddsNNn82Bg37CGoMpjBKBuZoNK/exec";
  window.GAS_API_URL = GAS_API_URL;

  function createProxy(s, f){
    return new Proxy({}, {
      get: (t, prop) => {
        if (prop === 'withSuccessHandler') return (cb) => createProxy(cb, f);
        if (prop === 'withFailureHandler') return (cb) => createProxy(s, cb);
        return (...args) => fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: prop, args: args })
        })
        .then(r => r.text()).then(t => { 
          if (!t) throw new Error("Empty response from GAS. Check FA_GAS_API_URL + deployment access.");
          try { return JSON.parse(t); } catch(e){ console.error("Non-JSON response:", t.slice(0,300)); throw e; }
        })
        .then(d => { if (d && d.ok && s) s(d.result); else if (d && d.ok === false && f) f(d); })
        .catch(e => { if (f) f(e); });
      }
    });
  }

  window.google = window.google || {};
  window.google.script = window.google.script || {};
  if (!window.google.script.run){
    window.google.script.run = new Proxy({}, { get: (t, prop) => createProxy(null, null)[prop] });
  }
})();
</script>

<div class="panel">
    <div class="panel-titlebar">ADMIN</div>


    <div class="panel" style="margin-top:14px;">
      <div class="h2">Season</div>
      <div class="row">
        <div class="field">
          <label for="seasonSelect">Active season</label>
          <select id="seasonSelect"><option value="">Loading…</option></select>
        </div>
        <div class="field" style="flex:0 0 220px; min-width:220px;">
          <button class="btn" id="saveSeasonBtn" type="button">Save season</button>
        </div>
      </div>
    </div>



    <div class="panel" style="margin-top:14px;">
      <div class="h2">Matchups</div>
      <div class="row">
        <div class="field" style="flex:1 1 auto;">
          <label class="toggleRow">
            <input type="checkbox" id="matchupsSortElo">
            <span>Sort all matchups by ELO</span>
          </label>
          <label class="toggleRow" style="margin-top:10px;">
            <input type="checkbox" id="matchupsSortEloOpp">
            <span>Sort opponent side only by ELO</span>
          </label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="teamSelect">Select Team</label>
        <select id="teamSelect"></select>
      </div>
</div>

    <div class="toolbar">
      <div class="toolbar-left">
        <div class="toggle">
          <input type="checkbox" id="showInactive">
          <label for="showInactive" style="margin:0; font-size:11px; font-weight:900;">Show inactive</label>
        </div>
        <button class="btn ghost" id="refreshBtn" type="button">Refresh</button>
      </div>
      <div class="muted" id="countLabel"></div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="h2">Add or update player</div>

      <div class="row">
        <div class="field">
          <label for="formTeam">Team</label>
          <input id="formTeam" list="teamList">
          <datalist id="teamList"></datalist>
        </div>

        <div class="field">
          <label for="formName">Name (required)</label>
          <input id="formName">
        </div>

        <div class="field">
          <label for="formRank">Rank (optional)</label>
          <input id="formRank">
        </div>

        <div class="field">
          <label for="formRating">Rating (optional)</label>
          <input id="formRating" type="number" inputmode="numeric">
        </div>
      </div>

      <div class="row" id="acesExtras" style="display:none;">
        <div class="field">
          <label for="formCaptainRank">Captain Rank (Aces only)</label>
          <input id="formCaptainRank" type="number" inputmode="numeric">
        </div>
        <div class="field">
          <label for="formLeagueAvg">League Avg (Aces only)</label>
          <input id="formLeagueAvg" type="number" inputmode="numeric">
        </div>
        <div class="field" style="flex:0 0 220px; min-width:220px;">
          <button class="btn" id="saveBtn" type="button">Save player</button>
          <button class="btn secondary" id="clearBtn" type="button" style="margin-left:8px;">Clear</button>
        </div>
      </div>

      <div class="row" id="nonAcesBtns">
        <div class="field" style="flex:0 0 220px; min-width:220px;">
          <button class="btn" id="saveBtn2" type="button">Save player</button>
          <button class="btn secondary" id="clearBtn2" type="button" style="margin-left:8px;">Clear</button>
        </div>
      </div>

      <div class="muted" id="editHint" style="margin-top:10px;"></div>
    </div>

    <div class="table-wrap"><table id="playersTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Rank</th>
      <th>Rating</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>
  </div>

  <div class="toast" id="toast"></div>

  

<!-- Bottom action -->
<div class="bottom-bar">
  <div class="bottom-inner">
    <button class="btn-blue" id="openLeagueLogBtn" type="button">ENTER LEAGUE MATCH</button>
  </div>
</div>

<!-- League Match Modal -->
<div class="modal" id="leagueMatchModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="leagueMatchModalTitle">
    <div class="modal-head">
      <div class="title" id="leagueMatchModalTitle">ENTER LEAGUE MATCH</div>
      <button class="icon-btn" id="closeLeagueModalBtn" type="button" aria-label="Close"><span>×</span></button>
    </div>

    <div class="form-grid">
      <div class="field">
        <label for="lmDate">Date</label>
        <input id="lmDate" type="date">
      </div>

      <div class="field">
        <label for="lmMode">Mode</label>
        <select id="lmMode">
          <option value="singles">Singles</option>
          <option value="doubles">Doubles</option>
          <option value="triples">Triples</option>
        </select>
      </div>

      <div class="field">
        <label for="lmTeamA">Team A</label>
        <select id="lmTeamA"><option value="">Loading…</option></select>
      </div>
      <div class="field">
        <label for="lmTeamB">Team B</label>
        <select id="lmTeamB"><option value="">Loading…</option></select>
      </div>

      <div class="field">
        <label for="lmResult">Result (Team A)</label>
        <select id="lmResult">
          <option value="W">Win</option>
          <option value="L">Loss</option>
          <option value="T">Tie</option>
        </select>
      </div>

      <div class="field">
        <label for="lmScoreMode">Score Mode</label>
        <select id="lmScoreMode">
          <option value="match">Match Play</option>
          <option value="stroke">Stroke</option>
        </select>
      </div>

      <!-- ✅ Updated doubles input order: A1, A2, B1, B2 (a-a-b-b) -->
      <div class="field">
        <label for="lmA1">Team A Player 1</label>
        <select id="lmA1"><option value="">Select…</option></select>
      </div>

      <div class="field" id="lmA2Field">
        <label for="lmA2">Team A Player 2</label>
        <select id="lmA2"><option value="">Select…</option></select>
      </div>

      <div class="field" id="lmA3Field" style="display:none">
        <label for="lmA3">Team A Player 3</label>
        <select id="lmA3"><option value="">Select…</option></select>
      </div>
      <div class="field">
        <label for="lmB1">Team B Player 1</label>
        <select id="lmB1"><option value="">Select…</option></select>
      </div>

      <div class="field" id="lmB2Field">
        <label for="lmB2">Team B Player 2</label>
        <select id="lmB2"><option value="">Select…</option></select>
      </div>

      <div class="field" id="lmB3Field" style="display:none">
        <label for="lmB3">Team B Player 3</label>
        <select id="lmB3"><option value="">Select…</option></select>
      </div>
      <div class="field" id="lmMpField" style="grid-column: 1 / -1;">
        <label for="lmMpScore">Match Play Score (Team A)</label>
        <select id="lmMpScore"><option value="">Select…</option></select>
      </div>

      <div class="field" id="lmStrokeFieldA">
        <label for="lmAScore">Team A Score</label>
        <input id="lmAScore" inputmode="numeric" type="number" placeholder="">
      </div>
      <div class="field" id="lmStrokeFieldB">
        <label for="lmBScore">Team B Score</label>
        <input id="lmBScore" inputmode="numeric" type="number" placeholder="">
      </div>
</div>

    <div class="btn-row">
      <button class="btn-gray" id="cancelLeagueBtn" type="button">CANCEL</button>
      <button class="btn-blue" id="submitLeagueBtn" type="button">SAVE LEAGUE MATCH</button>
    </div>
  </div>
</div>

<script>
    var ALL = [];
    var ACTIVE_TEAM
    const FA_ADMIN_CACHE_KEY = "FA_ADMIN_CACHE_V1";

    function _adminReadCache(){
      try{ return JSON.parse(localStorage.getItem(FA_ADMIN_CACHE_KEY) || "null"); }catch(_){ return null; }
    }
    function _adminWriteCache(partial){
      try{
        const cur = _adminReadCache() || {};
        const next = Object.assign({}, cur, partial || {}, { ts: Date.now() });
        localStorage.setItem(FA_ADMIN_CACHE_KEY, JSON.stringify(next));
      }catch(_){}
    }
    function _adminApplyCache(c){
      if (!c || typeof c !== "object") return false;
      try{
        if (c.seasonCfg && typeof setSeasonOptions === "function") setSeasonOptions(c.seasonCfg);
      }catch(_){}
      try{
        if (c.matchupsCfg){
          if ($("matchupsSortElo")) $("matchupsSortElo").checked = !!c.matchupsCfg.useEloSort;
          if ($("matchupsSortEloOpp")) $("matchupsSortEloOpp").checked = !!c.matchupsCfg.useOppEloSort;
        }
      }catch(_){}
      try{
        if (c.playersRes){
          const res = c.playersRes;
          ALL = (res && (res.players || res.rows || res.data)) ? (res.players || res.rows || res.data) : [];
          const teams = (res && (res.teams || res.teamList) && (res.teams||res.teamList).length) ? (res.teams||res.teamList) : ['Flying Aces'];
          if (typeof setTeamOptions === "function") setTeamOptions(teams);
          if (typeof renderTable === "function") renderTable();
        }
      }catch(_){}
      return true;
    }
 = '';
    var EDITING_ID = null;

    function $(id){ return document.getElementById(id); }
    function norm(s){ return String(s||'').trim(); }
    function isAces(team){ return norm(team).toLowerCase() === 'flying aces'; }

    function toast(msg){
      var t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._tmr);
      t._tmr = setTimeout(function(){ t.style.display='none'; }, 2400);
    }


    function setSeasonOptions(cfg){
      var sel = $('seasonSelect');
      if (!sel) return;

      var seasons = (cfg && cfg.seasons) ? cfg.seasons.slice() : [];
      seasons = seasons.filter(function(x){ return !!String(x||'').trim(); });

      // Show most recent first
      seasons.sort();
      seasons.reverse();

      sel.innerHTML = '';

      // Always include "All seasons"
      var oAll = document.createElement('option');
      oAll.value = 'all';
      oAll.textContent = 'All seasons';
      sel.appendChild(oAll);

      seasons.forEach(function(k){
        var o = document.createElement('option');
        o.value = k;
        o.textContent = k;
        sel.appendChild(o);
      });

      var active = (cfg && cfg.activeSeason) ? String(cfg.activeSeason) : '';
      if (!active) active = 'all';
      sel.value = active;
    }

    function loadSeasonConfig(){
      var sel = $('seasonSelect');
      var btn = $('saveSeasonBtn');
      if (btn) btn.disabled = true;

      google.script.run
        .withSuccessHandler(function(cfg){
          setSeasonOptions(cfg);
          _adminWriteCache({ seasonCfg: cfg });
          if (btn) btn.disabled = false;
        })
        .withFailureHandler(function(err){
          if (btn) btn.disabled = false;
          toast('Season load error: ' + (err && err.message ? err.message : err));
          if (sel) sel.innerHTML = '<option value="all">All seasons</option>';
        })
        .faGetSeasonConfig();
    }

    function bindSeasonControls(){
      var btn = $('saveSeasonBtn');
      if (!btn) return;

      btn.addEventListener('click', function(){
        var sel = $('seasonSelect');
        var v = sel ? String(sel.value||'') : '';
        if (!v) v = 'all';

        btn.disabled = true;
        google.script.run
          .withSuccessHandler(function(){
            toast('Saved');
            btn.disabled = false;
            // Re-load so the dropdown reflects any normalization
            loadSeasonConfig();
          })
          .withFailureHandler(function(err){
            btn.disabled = false;
            toast('Error: ' + (err && err.message ? err.message : err));
          })
          .faSetActiveSeason(v);
      });
    }

    function setTeamOptions(teams){
      var sel = $('teamSelect');
      sel.innerHTML = '';

      // ✅ Default option: show all players
      var optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'All Players';
      sel.appendChild(optAll);

      (teams||[]).forEach(function(t){
        var opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      // ✅ Default on page visit: All Players
      sel.value = '';

      // Always allow selection (All Players is always valid)
      sel.disabled = false;


      // datalist for free-typed team
      var dl = $('teamList');
      dl.innerHTML = '';
      (teams||[]).forEach(function(t){
        var o = document.createElement('option');
        o.value = t;
        dl.appendChild(o);
      });
    }

    function updateAcesExtrasVisibility(){
      var team = norm($('formTeam').value || $('teamSelect').value);
      $('acesExtras').style.display = isAces(team) ? 'flex' : 'none';
      $('nonAcesBtns').style.display = isAces(team) ? 'none' : 'flex';
    }

    function refresh(){
      toast('Loading…');
      var showInactive = $('showInactive').checked;
      google.script.run
        .withSuccessHandler(function(res){
          ALL = (res && (res.players || res.rows || res.data)) ? (res.players || res.rows || res.data) : [];
          
          if (res && res.meta && res.meta.error){
            toast(res.meta.error);
            ALL = [];
            setTeamOptions(['Flying Aces']);
            renderTable();
            return;
          }
var teams = (res && (res.teams || res.teamList) && (res.teams||res.teamList).length) ? (res.teams||res.teamList) : ['Flying Aces'];
          // Ensure Flying Aces always present
          if (teams.map(function(x){return norm(x).toLowerCase();}).indexOf('flying aces')<0) teams.unshift('Flying Aces');

          setTeamOptions(teams);
          _adminWriteCache({ playersRes: res });

          // Keep selected team stable if possible
          if (ACTIVE_TEAM){
            var sel = $('teamSelect');
            var has = teams.map(function(x){return norm(x).toLowerCase();}).indexOf(norm(ACTIVE_TEAM).toLowerCase())>=0;
            if (has) sel.value = ACTIVE_TEAM;
          }
          ACTIVE_TEAM = $('teamSelect').value;

          renderTable();
          if (ALL.length){
          toast(
  'Loaded ' + ALL.length + ' players ' +
  '(ss "' + (res.meta && res.meta.spreadsheetName || '?') + '", ' +
  'id ' + (res.meta && res.meta.spreadsheetId || '?') + ', ' +
  'usedId ' + (res.meta && res.meta.usedId || '?') + ', ' +
  'sheet "' + (res.meta && res.meta.sheetName || '?') + '", ' +
  'headerRow ' + (res.meta && res.meta.headerRow || '?') + ', ' +
  'lastRow ' + (res.meta && res.meta.lastRow || '?') + ', ' +
  'by ' + (res.meta && res.meta.foundBy || '?') + ')'
);
        } else {
          res = res || {}; res.meta = res.meta || {};
          var lr = (res && res.meta && (res.meta.lastRow!=null)) ? res.meta.lastRow : '?';
          var sn = (res && res.meta && res.meta.sheetName) ? res.meta.sheetName : 'PlayersDB';
          var err = (res && res.meta && res.meta.error) ? (' — ' + res.meta.error) : '';
          toast('Loaded 0 players (ss "' + (res.meta.spreadsheetName||'?') + '", id ' + (res.meta.spreadsheetId||'?') + ', usedId ' + (res.meta.usedId||'?') + ', sheet "' + sn + '", lastRow ' + lr + ', by ' + (res.meta.foundBy||'?') + ')' + (res.meta.ssError ? (' — ssError: ' + res.meta.ssError) : '') + err);
        }
        })
        .withFailureHandler(function(err){
          toast('Error: ' + (err && err.message ? err.message : err));
        })
        .faAdminPlayersDbList_v20260206({ includeInactive: !!showInactive, spreadsheetId: '1GXmT-6SOx0VoKxEPmQAaYKH_WCPcuU2zzs0P6RfSfXE' });
    }

    function renderTable(){
      var team = norm($('teamSelect').value);
      ACTIVE_TEAM = team;
      var showInactive = $('showInactive').checked;

      var rows = ALL.filter(function(p){
        if (!p) return false;
        if (team && norm(p.team).toLowerCase() !== team.toLowerCase()) return false;
        if (!showInactive && !p.active) return false;
        return true;
      });

            // ✅ Always sort alphabetically by player name (All Players or Team filter)
      rows.sort(function(a,b){
        var an = norm(a && a.name ? a.name : '').toLowerCase();
        var bn = norm(b && b.name ? b.name : '').toLowerCase();
        if (an < bn) return -1;
        if (an > bn) return 1;
        // stable fallback (id if present)
        var ai = String(a && (a.id||a.pid||a.playerId||''));
        var bi = String(b && (b.id||b.pid||b.playerId||''));
        return ai.localeCompare(bi);
      });

$('countLabel').textContent = rows.length + ' shown';

      var tb = $('playersTable').querySelector('tbody');
      tb.innerHTML = '';
      rows.forEach(function(p){
  var tr = document.createElement('tr');

  // --- Name cell (Name + Active pill) ---
  var td1 = document.createElement('td');

  var nameWrap = document.createElement('div');
  nameWrap.className = 'nameCell';

  var nm = document.createElement('div');
  nm.className = 'nm';
  nm.textContent = p.name || '';

  var pill = document.createElement('span');
  pill.className = 'pill ' + (p.active ? 'on':'off');
  pill.textContent = p.active ? 'Active' : 'Inactive';

  nameWrap.appendChild(nm);
  nameWrap.appendChild(pill);
  td1.appendChild(nameWrap);

  // --- Rank / Rating ---
  var td2 = document.createElement('td'); td2.textContent = (p.rank || '');
  var td3 = document.createElement('td'); td3.textContent = (p.rating ? p.rating : '');

  // --- Actions ---
  var td4 = document.createElement('td');
  var act = document.createElement('div'); act.className = 'actions';

  var editBtn = document.createElement('button');
  editBtn.className = 'btn ghost';
  editBtn.textContent = 'Edit';
  editBtn.onclick = function(){ loadIntoForm(p); };

  var toggleBtn = document.createElement('button');
  toggleBtn.className = 'btn ' + (p.active ? 'secondary' : '');
  // shorter labels so mobile never clips
  toggleBtn.textContent = p.active ? 'Off' : 'On';
  toggleBtn.onclick = function(){ setActive(p.id, !p.active); };

  act.appendChild(editBtn);
  act.appendChild(toggleBtn);
  td4.appendChild(act);

  tr.appendChild(td1);
  tr.appendChild(td2);
  tr.appendChild(td3);
  tr.appendChild(td4);
  tb.appendChild(tr);
});


      updateAcesExtrasVisibility();
    }

    function loadIntoForm(p){
      EDITING_ID = p.id || null;
      $('formTeam').value = p.team || $('teamSelect').value || 'Flying Aces';
      $('formName').value = p.name || '';
      $('formRank').value = p.rank || '';
      $('formRating').value = (p.rating ? p.rating : '');
      $('formCaptainRank').value = (p.captainRank ? p.captainRank : '');
      $('formLeagueAvg').value = (p.leagueAvg ? p.leagueAvg : '');
      $('editHint').textContent = 'Editing: ' + (p.name||'') + ' (' + (p.team||'') + ')';
      updateAcesExtrasVisibility();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearForm(){
      EDITING_ID = null;
      $('formTeam').value = $('teamSelect').value || 'Flying Aces';
      $('formName').value = '';
      $('formRank').value = '';
      $('formRating').value = '';
      $('formCaptainRank').value = '';
      $('formLeagueAvg').value = '';
      $('editHint').textContent = '';
      updateAcesExtrasVisibility();
    }

    function save(){
      var team = norm($('formTeam').value) || 'Flying Aces';
      var name = norm($('formName').value);
      if (!name){ toast('Name is required'); return; }

      var payload = {
        id: EDITING_ID,
        team: team,
        name: name,
        rank: norm($('formRank').value),
        rating: norm($('formRating').value),
        captainRank: norm($('formCaptainRank').value),
        leagueAvg: norm($('formLeagueAvg').value)
      };

      $('saveBtn').disabled = true;
      $('saveBtn2').disabled = true;

      google.script.run
        .withSuccessHandler(function(res){
          toast('Saved');
          clearForm();
          refresh();
        })
        .withFailureHandler(function(err){
          toast('Error: ' + (err && err.message ? err.message : err));
          $('saveBtn').disabled = false;
          $('saveBtn2').disabled = false;
        })
        .faPlayersDbUpsert(payload);
    }

    function setActive(id, active){
      if (!id) return;
      google.script.run
        .withSuccessHandler(function(){
          toast(active ? 'Restored' : 'Deactivated');
          refresh();
        })
        .withFailureHandler(function(err){
          toast('Error: ' + (err && err.message ? err.message : err));
        })
        .faPlayersDbSetActive(id, active);
    }

    
    $('refreshBtn').onclick = refresh;
    $('teamSelect').onchange = renderTable;
    $('showInactive').onchange = renderTable;    $('saveBtn').onclick = save;
    $('saveBtn2').onclick = save;

    $('clearBtn').onclick = clearForm;
    $('clearBtn2').onclick = clearForm;

    $('formTeam').oninput = updateAcesExtrasVisibility;
    $('teamSelect').addEventListener('change', function(){
      $('formTeam').value = $('teamSelect').value || 'Flying Aces';
      updateAcesExtrasVisibility();
    });

    
    /* ===========================
       LEAGUE MATCH ENTRY (moved from Stats)
       =========================== */

    const FA_LEAGUELOG_CTX_KEY = "FA_ADMIN_LEAGUELOG_CTX_V1";
    const MATCHPLAY_SCORES = [
      "PUSH",
      "1 UP","2 UP",
      "2 & 1","3 & 1","3 & 2","4 & 2","4 & 3","5 & 3","5 & 4","6 & 4","6 & 5","7 & 5","7 & 6","8 & 6","8 & 7","9 & 7","9 & 8","10 & 8"
    ];

    function _key(s){ return String(s||"").trim().toLowerCase(); }
    function esc(s){
      return String(s==null?"":s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
    }
    function fillSelectSimple(id, items, placeholder, selectedVal, labelFn){
      const el = $(id);
      if (!el) return;
      el.innerHTML = "";
      if (placeholder != null){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        el.appendChild(opt);
      }
      (items || []).forEach(v => {
        const val = String(v ?? "").trim();
        if (!val) return;
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = labelFn ? labelFn(val) : val;
        el.appendChild(opt);
      });
      if (selectedVal != null) el.value = selectedVal;
    }
    function dispTeamName(s){ return (s||"").toString().replace(/^OPP\s*-\s*/i,"").trim(); }
    function fillSelectExact(elId, items, selected){
      const el = (typeof elId === "string") ? $(elId) : elId;
      if (!el) return;
      const aces = "Flying Aces";
      items = (items || []).map(s => String(s||"").trim()).filter(Boolean);
      items = items.slice().sort((a,b)=>a.localeCompare(b));
      const idx = items.findIndex(x => _key(x) === _key(aces));
      if (idx >= 0){ items.splice(idx,1); items.unshift(aces); }
      el.innerHTML = items.map(s => `<option value="${esc(s)}">${esc(dispTeamName(s))}</option>`).join("");
      if (selected && items.some(x => _key(x) === _key(selected))) el.value = selected;
    }

    function _getLeagueLogCtx(){
      return {
        matchDate: $("lmDate") ? ($("lmDate").value || "") : "",
        mode: $("lmMode") ? ($("lmMode").value || "") : "",
        teamA: $("lmTeamA") ? ($("lmTeamA").value || "") : "",
        teamB: $("lmTeamB") ? ($("lmTeamB").value || "") : "",
        scoreMode: $("lmScoreMode") ? ($("lmScoreMode").value || "") : "",
        result: $("lmResult") ? ($("lmResult").value || "") : ""
      };
    }
    function persistLeagueLogCtx(){
      try{ localStorage.setItem(FA_LEAGUELOG_CTX_KEY, JSON.stringify(_getLeagueLogCtx())); }catch(_){}
    }
    function restoreLeagueLogCtx(){
      if (!$("lmDate") || !$("lmMode") || !$("lmTeamA") || !$("lmTeamB")) return;
      let ctx = null;
      try{ ctx = JSON.parse(localStorage.getItem(FA_LEAGUELOG_CTX_KEY) || "null"); }catch(_){}
      if (!ctx || typeof ctx !== "object") return;
      if (ctx.matchDate) $("lmDate").value = ctx.matchDate;
      if (ctx.mode === "singles" || ctx.mode === "doubles" || ctx.mode === "triples") $("lmMode").value = ctx.mode;
      if ($("lmScoreMode") && ctx.scoreMode){
        const hasSM = Array.from($("lmScoreMode").options).some(o => o.value === ctx.scoreMode);
        if (hasSM) $("lmScoreMode").value = ctx.scoreMode;
      }
      if ($("lmResult") && ctx.result){
        const hasR = Array.from($("lmResult").options).some(o => o.value === ctx.result);
        if (hasR) $("lmResult").value = ctx.result;
      }
      if (ctx.teamA) $("lmTeamA").value = ctx.teamA;
      if (ctx.teamB) $("lmTeamB").value = ctx.teamB;
    }

    function openLeagueModal(){
      if (!$("leagueMatchModal")) return;
      $("leagueMatchModal").classList.add("show");
      $("leagueMatchModal").setAttribute("aria-hidden","false");

      // Ensure team lists are loaded once
      loadLeagueTeams(() => {
        try{ restoreLeagueLogCtx(); }catch(_){}
        try{
          if ($("lmDate") && !$("lmDate").value) $("lmDate").valueAsDate = new Date();
        }catch(_){}

        try{
          loadLeagueTeamRoster($("lmTeamA").value, "A");
          loadLeagueTeamRoster($("lmTeamB").value, "B");
        }catch(_){}

        showLeagueMode();
        showLeagueScoreMode();
        maybeAutoLeagueResultFromScores();
        try{ $("lmA1") && $("lmA1").focus(); }catch(_){}
      });
    }
    function closeLeagueModal(){
      if (!$("leagueMatchModal")) return;
      $("leagueMatchModal").classList.remove("show");
      $("leagueMatchModal").setAttribute("aria-hidden","true");
    }

    let _leagueTeamsLoaded = false;
    function loadLeagueTeams(cb){
      cb = (typeof cb === "function") ? cb : function(){};
      if (_leagueTeamsLoaded && $("lmTeamA") && $("lmTeamA").options.length > 0){ cb(); return; }

      google.script.run
        .withSuccessHandler(res => {
          if (typeof res === "string"){ try{ res = JSON.parse(res); }catch(_){ } }
          const teams = (res && Array.isArray(res.teams)) ? res.teams : (Array.isArray(res) ? res : []);
          fillSelectExact("lmTeamA", teams || [], $("lmTeamA") ? $("lmTeamA").value : "");
          fillSelectExact("lmTeamB", teams || [], $("lmTeamB") ? $("lmTeamB").value : "");
          _leagueTeamsLoaded = true;
          _adminWriteCache({ leagueTeams: teams || [] });
          cb();
        })
        .withFailureHandler(err => {
          toast("Team load failed", 2200);
          cb();
        })
        .faGetLeagueTeams_v2();
    }

    function showLeagueMode(){
      const mode = ($("lmMode") && $("lmMode").value) ? $("lmMode").value : "singles";
      const isS = (mode === "singles");
      const isT = (mode === "triples");

      if ($("lmA2Field")) $("lmA2Field").style.display = isS ? "none" : "";
      if ($("lmB2Field")) $("lmB2Field").style.display = isS ? "none" : "";

      if ($("lmA3Field")) $("lmA3Field").style.display = isT ? "" : "none";
      if ($("lmB3Field")) $("lmB3Field").style.display = isT ? "" : "none";

      // Force stroke play for doubles/triples
      const scoreMode = $("lmScoreMode");
      if (scoreMode){
        if (isS){
          scoreMode.disabled = false;
        } else {
          scoreMode.value = "stroke";
          scoreMode.disabled = true;
        }
      }
      showLeagueScoreMode();
      maybeAutoLeagueResultFromScores();
    }

    function showLeagueScoreMode(){
      const mode = ($("lmMode") && $("lmMode").value) ? $("lmMode").value.toLowerCase() : "singles";
      const sm = ($("lmScoreMode") && $("lmScoreMode").value) ? $("lmScoreMode").value.toLowerCase() : "match";
      const isStroke = (mode === "doubles" || mode === "triples") || (sm === "stroke");

      if ($("lmMpField")) $("lmMpField").style.display = isStroke ? "none" : "";
      if ($("lmStrokeFieldA")) $("lmStrokeFieldA").style.display = isStroke ? "" : "none";
      if ($("lmStrokeFieldB")) $("lmStrokeFieldB").style.display = isStroke ? "" : "none";

      // init match play scores (singles only)
      if (!isStroke && $("lmMpScore") && $("lmMpScore").options.length <= 1){
        fillSelectSimple("lmMpScore", MATCHPLAY_SCORES, "Select…");
        $("lmMpScore").value = "PUSH";
      }

      maybeAutoLeagueResultFromScores();
      persistLeagueLogCtx();
    }

    function maybeAutoLeagueResultFromScores(){
      const mode = ($("lmMode") && $("lmMode").value) ? $("lmMode").value.toLowerCase() : "singles";
      const sm = ($("lmScoreMode") && $("lmScoreMode").value) ? $("lmScoreMode").value.toLowerCase() : "match";
      const isStroke = (mode === "doubles" || mode === "triples") || (sm === "stroke");
      if (!isStroke) return;

      const a = Number($("lmAScore") ? $("lmAScore").value : NaN);
      const b = Number($("lmBScore") ? $("lmBScore").value : NaN);
      if (!isFinite(a) || !isFinite(b)) return;

      if ($("lmResult")){
        if (a === b) $("lmResult").value = "T";
        else if (a < b) $("lmResult").value = "W"; // lower score wins
        else $("lmResult").value = "L";
      }
    }

    function loadLeagueTeamRoster(teamId, which){
      if ((teamId === "A" || teamId === "B") && !which){
        which = teamId;
        teamId = (which === "A") ? ($("lmTeamA") ? $("lmTeamA").value : "") : ($("lmTeamB") ? $("lmTeamB").value : "");
      }
      which = (which === "A" || which === "B") ? which : "B";

      const sel1 = (which === "A") ? "lmA1" : "lmB1";
      const sel2 = (which === "A") ? "lmA2" : "lmB2";
      const sel3 = (which === "A") ? "lmA3" : "lmB3";

      fillSelectSimple(sel1, [], "Select…");
      fillSelectSimple(sel2, [], "Select…");
      if ($(sel3)) fillSelectSimple(sel3, [], "Select…");

      if (!teamId) return;

      google.script.run
        .withSuccessHandler(res => {
          if (typeof res === "string"){ try{ res = JSON.parse(res); }catch(_){ } }
          let players = [];
          if (Array.isArray(res)) players = res;
          else if (res && Array.isArray(res.players)) players = res.players;
          else if (res && res.ok && Array.isArray(res.players)) players = res.players;

          players = (players||[]).map(x => (x==null ? "" : String(x))).filter(Boolean);

          fillSelectSimple(sel1, players, "Select…");
          fillSelectSimple(sel2, players, "Select…");
          if ($(sel3)) fillSelectSimple(sel3, players, "Select…");
        })
        .withFailureHandler(err => toast("Roster load failed", 2200))
        .faGetTeamPlayers_v2(teamId);
    }

    function clearLeagueEntryFields(){
      // Keep: date/mode/teams/score mode/result
      // Clear: players + scores
      ["lmA1","lmA2","lmA3","lmB1","lmB2","lmB3"].forEach(id => { if ($(id)) $(id).value = ""; });
      if ($("lmMpScore")) $("lmMpScore").value = "";
      if ($("lmAScore")) $("lmAScore").value = "";
      if ($("lmBScore")) $("lmBScore").value = "";
    }

    function submitLeagueMatch(){
      const mode = ($("lmMode") && $("lmMode").value) ? $("lmMode").value.toLowerCase() : "singles";
      const teamA = $("lmTeamA") ? ($("lmTeamA").value || "") : "";
      const teamB = $("lmTeamB") ? ($("lmTeamB").value || "") : "";
      const scoreMode = ($("lmScoreMode") && $("lmScoreMode").value) ? $("lmScoreMode").value.toLowerCase() : "match";
      const result = $("lmResult") ? ($("lmResult").value || "W") : "W";

      persistLeagueLogCtx();

      const entry = {
        matchDate: $("lmDate") ? ($("lmDate").value || "") : "",
        mode: mode,
        teamA: teamA,
        teamB: teamB,
        result: result,
        scoreMode: scoreMode,
        a1: $("lmA1") ? ($("lmA1").value || "") : "",
        a2: $("lmA2") ? ($("lmA2").value || "") : "",
        b1: $("lmB1") ? ($("lmB1").value || "") : "",
        b2: $("lmB2") ? ($("lmB2").value || "") : "",
        a3: (mode === "triples" && $("lmA3")) ? ($("lmA3").value || "") : "",
        b3: (mode === "triples" && $("lmB3")) ? ($("lmB3").value || "") : ""
      };

      if (mode === "doubles" || scoreMode === "stroke"){
        entry.aScore = $("lmAScore") ? ($("lmAScore").value || "") : "";
        entry.bScore = $("lmBScore") ? ($("lmBScore").value || "") : "";
      } else {
        entry.mpScore = $("lmMpScore") ? ($("lmMpScore").value || "") : "";
      }

      if ($("submitLeagueBtn")) $("submitLeagueBtn").disabled = true;

      google.script.run
        .withSuccessHandler(data => {
          if ($("submitLeagueBtn")) $("submitLeagueBtn").disabled = false;
          if (typeof data === "string"){ try{ data = JSON.parse(data); }catch(_){ } }
          if (!data){ toast("Save failed (no response)", 2200); return; }
          if (data.ok === false){ toast(String(data.error || "Save failed"), 2600); return; }

          toast("Saved — enter next match", 1400);
          clearLeagueEntryFields();
        })
        .withFailureHandler(err => {
          if ($("submitLeagueBtn")) $("submitLeagueBtn").disabled = false;
          toast("Save failed", 2200);
        })
        .faAddLeagueMatchLogEntry_v2(entry);
    }

    // Wire Admin league modal
    if ($("openLeagueLogBtn")) $("openLeagueLogBtn").addEventListener("click", openLeagueModal);
    if ($("closeLeagueModalBtn")) $("closeLeagueModalBtn").addEventListener("click", closeLeagueModal);
    if ($("cancelLeagueBtn")) $("cancelLeagueBtn").addEventListener("click", closeLeagueModal);
    if ($("submitLeagueBtn")) $("submitLeagueBtn").addEventListener("click", submitLeagueMatch);

    if ($("lmTeamA")) $("lmTeamA").addEventListener("change", () => { persistLeagueLogCtx(); loadLeagueTeamRoster($("lmTeamA").value, "A"); });
    if ($("lmTeamB")) $("lmTeamB").addEventListener("change", () => { persistLeagueLogCtx(); loadLeagueTeamRoster($("lmTeamB").value, "B"); });
    if ($("lmMode"))  $("lmMode").addEventListener("change", () => { persistLeagueLogCtx(); showLeagueMode(); });
    if ($("lmScoreMode")) $("lmScoreMode").addEventListener("change", () => { persistLeagueLogCtx(); showLeagueScoreMode(); });
    if ($("lmDate")) $("lmDate").addEventListener("change", persistLeagueLogCtx);
    if ($("lmResult")) $("lmResult").addEventListener("change", persistLeagueLogCtx);
    if ($("lmAScore")) $("lmAScore").addEventListener("input", () => { maybeAutoLeagueResultFromScores(); persistLeagueLogCtx(); });
    if ($("lmBScore")) $("lmBScore").addEventListener("input", () => { maybeAutoLeagueResultFromScores(); persistLeagueLogCtx(); });

    // Close by tapping outside card
    if ($("leagueMatchModal")){
      $("leagueMatchModal").addEventListener("click", (e) => { if (e.target === $("leagueMatchModal")) closeLeagueModal(); });
    }


    // Ensure header highlights correctly for the ADMIN route (supports both admin + legacy players)
    (function(){
      try{
        if (typeof setActiveByPage === "function"){
          var hasAdmin = document.querySelector('[data-page="admin"], a[href*="p=admin"], button[onclick*="admin"]');
          setActiveByPage(hasAdmin ? "admin" : "players");
        }
      }catch(_){}
    })();

    /* ---------- Matchups sort (Elo) ---------- */
    function loadMatchupsSortConfig(){
      google.script.run
        .withSuccessHandler(function(cfg){
          try{
            if (typeof cfg === 'string') cfg = JSON.parse(cfg);
          }catch(_){}
          var cbAll = $('matchupsSortElo');
          var cbOpp = $('matchupsSortEloOpp');
          if (cbAll) cbAll.checked = !!(cfg && cfg.useEloSort);
          if (cbOpp) cbOpp.checked = !!(cfg && cfg.useOppEloSort);
          _adminWriteCache({ matchupsCfg: { useEloSort: !!(cfg && cfg.useEloSort), useOppEloSort: !!(cfg && cfg.useOppEloSort) } });
        })
        .withFailureHandler(function(err){
          toast('Matchups setting load error: ' + (err && err.message ? err.message : err));
        })
        .faGetMatchupsSortConfig();
    }

    function bindMatchupsSortControls(){
      var cbAll = $('matchupsSortElo');
      var cbOpp = $('matchupsSortEloOpp');

      function saveNow(){
        var payload = {
          useEloSort: !!(cbAll && cbAll.checked),
          useOppEloSort: !!(cbOpp && cbOpp.checked)
        };

        google.script.run
          .withSuccessHandler(function(){
            toast('Saved');
          })
          .withFailureHandler(function(err){
            toast('Save error: ' + (err && err.message ? err.message : err));
            // revert to server value
            loadMatchupsSortConfig();
          })
          .faSetMatchupsSortConfig(payload);
      }

      if (cbAll) cbAll.addEventListener('change', saveNow);
      if (cbOpp) cbOpp.addEventListener('change', saveNow);
    }


    // init
    bindSeasonControls();
    loadSeasonConfig();
    bindMatchupsSortControls();
    loadMatchupsSortConfig();
    clearForm();
    _adminApplyCache(_adminReadCache());
    refresh();
  </script>
</body>
</html>
