<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- ✅ Disable pinch/zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Flying Aces</title>

  <style>
    :root { --vh: 1vh; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* wrapper never scrolls; iframe does */
      background: #0b0c10;

      /* Let browser handle gestures (better iframe scrolling) */
      touch-action: auto;
    }

    /* ✅ Simple top loading bar (replaces "native" browser loading feedback) */
    #faLoadBar{
      position: fixed;
      top: env(safe-area-inset-top, 0);
      left: 0;
      height: 3px;
      width: 0%;
      opacity: 0;
      background: #0d6efd;
      z-index: 999999;
      pointer-events: none;
      transition: opacity .12s ease, width .35s ease;
    }
    #faLoadBar.on{
      opacity: 1;
      width: 70%;
    }
    #faLoadBar.done{
      opacity: 1;
      width: 100%;
      transition: width .12s linear, opacity .25s ease .10s;
    }

    /* Fullscreen iframe */
    #app {
      position: fixed;
      touch-action: auto;
      inset: 0;
      width: 100%;
      height: calc(var(--vh) * 100);
      border: 0;
      background: #ffffff;
    }

    @supports (height: 100dvh) {
      #app { height: 100dvh; }
    }

    /* Optional debug overlay */
    #debug {
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.72);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
      line-height: 1.25;
      z-index: 999999;
      display: none;
    }
    #debug .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    #debug code { color: #b7ffb7; word-break: break-all; }
    #debug button {
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- ✅ Loading bar -->
  <div id="faLoadBar" aria-hidden="true"></div>

  <iframe id="app" title="Flying Aces" scrolling="yes"></iframe>

  <div id="debug">
    <div class="row" style="justify-content:space-between">
      <div><b>FA DEBUG</b> — native iframe scroll + iframe viewport scaling</div>
      <div id="dbgScale"></div>
    </div>
    <div style="margin-top:6px">
      <div><b>Page:</b> <span id="dbgPage"></span></div>
      <div><b>Iframe:</b> <code id="dbgSrc"></code></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnCopy">Copy iframe URL</button>
      <button id="btnReload">Reload</button>
    </div>
  </div>

  <script>
    (function () {

      /* ============================
         ✅ Pinch/zoom blocking (wrapper)
         ============================ */
      // iOS Safari fallback: prevent gesture-based zoom
      ['gesturestart','gesturechange','gestureend'].forEach(evt => {
        document.addEventListener(evt, e => e.preventDefault(), { passive:false });
      });

      // (removed) double-tap zoom blocker (was interfering with scroll)

/* ============================
         ✅ Loading bar helpers
         ============================ */
      const loadBar = document.getElementById("faLoadBar");
      let loadBarTimer = null;

      function showLoadBar(){
        if (!loadBar) return;
        loadBar.classList.remove("done");
        loadBar.classList.add("on");
        clearTimeout(loadBarTimer);
        // safety hide in case load never fires
        loadBarTimer = setTimeout(hideLoadBar, 8000);
      }

      function hideLoadBar(){
        if (!loadBar) return;
        loadBar.classList.add("done");
        clearTimeout(loadBarTimer);
        loadBarTimer = setTimeout(() => {
          loadBar.classList.remove("on");
          loadBar.classList.remove("done");
          loadBar.style.width = "";
        }, 350);
      }


      // ✅ Your Apps Script web app exec URL:
      const EXEC = "https://script.google.com/macros/s/AKfycbxaQ-sVp1efSpJ8GXQMFlfqY1sj6A-Laz3UdPy1eKzCnkivJPaMv7PBsrxPuHHhh-QG/exec";

      const ALLOWED = new Set(["rankings", "scoring", "rosters", "matchups", "stats", "elo", "standings", "scouting", "players", "admin", "matchlog"]);
      const DEFAULT_PAGE = "matchups";

      const iframe = document.getElementById("app");
      const debugEl = document.getElementById("debug");
      const dbgScale = document.getElementById("dbgScale");
      const dbgPage = document.getElementById("dbgPage");
      const dbgSrc  = document.getElementById("dbgSrc");

      let currentPage = null;
      let currentScale = null;

      // Hide the loading bar when the iframe finishes loading
      iframe.addEventListener("load", hideLoadBar);

      function qs(name) {
        return new URLSearchParams(location.search).get(name);
      }

      // Stable cache-bust value for this session (prevents iOS scroll/resize from reloading the iframe)
      const STABLE_V = qs("v") || String(Date.now());

      function normalizePage(p) {
        p = String(p || "").trim().toLowerCase();
        if (!p) return DEFAULT_PAGE;
        // allow "#matchups?x=1" etc
        p = p.split("?")[0].split("&")[0].replace(/^#/, "");
        return ALLOWED.has(p) ? p : DEFAULT_PAGE;
      }

      function setVhVar() {
        // keeps height stable with mobile address bar changes
        document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
      }

      // Source of truth: iframe viewport scale (NOT wrapper transform)
      function pickScale() {
        // Allow manual override: ?scale=0.62 or ?s=0.62 or ?sf=0.62
        const overrideRaw = qs("s") || qs("sf") || qs("scale");
        if (overrideRaw != null) {
          const v = Number(overrideRaw);
          if (Number.isFinite(v) && v >= 0.4 && v <= 1.2) return +v.toFixed(3);
        }

        const ua = navigator.userAgent || "";
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        const isAndroid = /Android/i.test(ua);

        // Auto scale by viewport width (CSS pixels)
        const w = Math.min(
          window.innerWidth || 9999,
          document.documentElement.clientWidth || 9999,
          screen.width || 9999
        );

        // ✅ Phones: make Android slightly larger, iOS slightly smaller
        if (w <= 520) {
          if (isIOS) return 0.55;      // slightly smaller on iOS
          if (isAndroid) return 0.57;  // slightly larger on Android
          return 0.56;                 // fallback
        }

        // Tablets / narrow desktop
        if (w <= 820) return 0.70;

        // Wide screens
        return 1.00;
      }

      function buildSrc(page, reloadNonce) {
        const p = normalizePage(page);
        const s = pickScale();

        const u = new URL(EXEC);
        u.searchParams.set("p", p);
        u.searchParams.set("embed", "1");
        u.searchParams.set("scale", String(s));

        // Stable cache-bust value (prevents iOS scroll/resize from reloading the iframe)
        u.searchParams.set("v", STABLE_V);

        // ✅ On forced reload: add a one-time nonce so the iframe truly reloads
        if (reloadNonce) {
          u.searchParams.set("r", String(reloadNonce));
          u.searchParams.set("fresh", "1"); // safe if unused
        }

        return { url: u.toString(), page: p, scale: s };
      }

      function getTargetPage() {
        // Prefer hash routing for the wrapper
        const fromHash = normalizePage((location.hash || "").slice(1));
        // Also accept ?p= for deep links
        const fromQuery = normalizePage(qs("p"));
        return (location.hash && location.hash.length > 1) ? fromHash : fromQuery || DEFAULT_PAGE;
      }

      function updateDebug(url, page, scale) {
        if (debugEl.style.display !== "block") return;
        dbgScale.textContent = "Scale: " + scale;
        dbgPage.textContent = page;
        dbgSrc.textContent = url;
      }

      function navigate(page, forceReload, reloadNonce) {
        const built = buildSrc(page, forceReload ? (reloadNonce || Date.now()) : null);

        // Track + reload only when needed
        const scaleChanged = (currentScale == null) || (Math.abs(built.scale - currentScale) > 0.0005);
        const pageChanged  = (currentPage == null) || (built.page !== currentPage);

        currentPage = built.page;
        currentScale = built.scale;

        // ✅ Only reload iframe when something actually changed OR a forceReload was requested
        if (forceReload || pageChanged || scaleChanged) {
          showLoadBar();            // ✅ show "tap happened" feedback
          iframe.src = built.url;
        }

        updateDebug(built.url, built.page, built.scale);
      }

      // Listen for messages from inside the Apps Script app (Header.html)
      window.addEventListener("message", (ev) => {
        const d = ev && ev.data;
        if (!d || typeof d !== "object") return;

        // Pull-to-refresh request from inside the iframe
        if (d.type === "FA_REFRESH") {
          const nonce = d.nonce || Date.now();
          // show bar even if same page
          showLoadBar();
          navigate(currentPage || getTargetPage(), true, nonce);
          return;
        }

        // Navigate to a page
        if (d.type === "FA_NAV") {
          const page = normalizePage(d.page);

          // Immediate feedback on tap:
          showLoadBar();

          // Keep hash in sync (so back button works)
          if (normalizePage((location.hash || "").slice(1)) !== page) {
            location.hash = "#" + page;
          } else {
            // same page retap = real reload
            navigate(page, true, Date.now());
          }
        }
      });

      window.addEventListener("hashchange", () => navigate(getTargetPage(), false));
      window.addEventListener("resize", () => {
        setVhVar();
        // If breakpoint changes, refresh so iframe gets new viewport scale
        navigate(currentPage || getTargetPage(), false);
      });

      // Debug UI toggle: ?debug=1
      if (qs("debug") === "1") {
        debugEl.style.display = "block";
        document.getElementById("btnCopy").onclick = async () => {
          try { await navigator.clipboard.writeText(iframe.src); } catch (e) {}
        };
        document.getElementById("btnReload").onclick = () => navigate(currentPage || getTargetPage(), true, Date.now());
      }

      // Boot
      setVhVar();
      if (!location.hash && !qs("p")) location.hash = "#" + DEFAULT_PAGE;
      showLoadBar();
      navigate(getTargetPage(), true, Date.now());
    })();
  </script>
</body>
</html>
