<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Flying Aces</title>

  <link rel="icon" type="image/png" href="https://lufberydiscgolf.wordpress.com/wp-content/uploads/2025/05/cropped-lufberyflyingace_logo_500x500-1.png?v=2">
  <link rel="apple-touch-icon" href="https://lufberydiscgolf.wordpress.com/wp-content/uploads/2025/05/cropped-lufberyflyingace_logo_500x500-1.png?v=2">

  <style>
    :root { --s: 1; }
    html, body { margin:0; padding:0; width:100%; height:100%; background:#fff; }

    /* ===== ANDROID/DESKTOP MODE (native iframe scroll, but wrapper-scaled) ===== */
    #nativeWrap{
      position:fixed;
      inset:0;
      overflow:hidden;           /* page itself does not scroll */
      background:#fff;
      display:none;              /* toggled by JS */
      overscroll-behavior:contain;
    }
    #nativeScaled{
      position:absolute;
      top:0; left:0;
      transform-origin:0 0;
      will-change:transform;
      width:  calc(100vw  / var(--s));
      height: calc(100dvh / var(--s));
      height: calc(100vh  / var(--s)); /* fallback */
      transform: scale(var(--s));
    }
    #nativeFrame{
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#fff;
    }

    /* ===== iOS MODE (wrapper scroll + scaled content + height sync) ===== */
    #frameWrap{
      position:fixed;
      inset:0;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action:pan-y;
      background:#fff;
      display:none; /* toggled by JS */
    }
    #scrollArea{ position:relative; width:100%; }
    #spacer{ width:100%; height:1200px; }
    #scaled{
      position:absolute;
      top:0; left:0;
      transform-origin:0 0;
      will-change:transform;
      width: calc(100vw / var(--s));
      transform: scale(var(--s)); /* NO zoom */
    }
    #iosFrame{
      width:100%;
      border:0;
      display:block;
      background:#fff;
      height:1200px; /* JS overwrites from FA_HEIGHT */
    }
  </style>
</head>

<body>
  <!-- Android/desktop: native scroll INSIDE the iframe, but visually scaled by wrapper -->
  <div id="nativeWrap">
    <div id="nativeScaled">
      <iframe id="nativeFrame" title="Flying Aces"></iframe>
    </div>
  </div>

  <!-- iOS: outer scroller + scaled content + height sync -->
  <div id="frameWrap">
    <div id="scrollArea">
      <div id="spacer"></div>
      <div id="scaled">
        <iframe id="iosFrame" title="Flying Aces"></iframe>
      </div>
    </div>
  </div>

<script>
(() => {
  const EXEC = "https://script.google.com/macros/s/AKfycbyD8Of8Rq69CMvLVSeTRmCtcj8WGwC-HsdIsYSEZ0b4ylA8TvihUztv9H2wGh4vDSpDaw/exec";
  const DEFAULT_PAGE = "matchups";
  const allowed = new Set(["matchups","rankings","rosters","scoring","doubles"]);

  // iOS mode needs a little bottom guard because the in-page bottom button bar can cover last rows.
  const PAD_VISIBLE = 260;   // try 220â€“320 if you ever need to tune
  const MIN_H = 900;
  const MAX_H = 65000;

  const nativeWrap  = document.getElementById("nativeWrap");
  const nativeFrame = document.getElementById("nativeFrame");

  const frameWrap   = document.getElementById("frameWrap");
  const spacer      = document.getElementById("spacer");
  const iosFrame    = document.getElementById("iosFrame");

  const root = document.documentElement;

  let isIOS = false;
  try {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    isIOS = iOS || iPadOS;
  } catch(e){}

  function normalizePage(p){
    p = String(p || "").toLowerCase().replace(/^#/, "").trim();
    if (!allowed.has(p)) p = DEFAULT_PAGE;
    if (p === "doubles") p = "rosters";
    return p;
  }

  function pickScale(){
    // Optional manual override for testing: ?sf=0.66
    const qs = new URLSearchParams(location.search || "");
    const manual = parseFloat(qs.get("sf"));
    if (isFinite(manual) && manual >= 0.45 && manual <= 1.0) return manual;

    const w = Math.min(window.innerWidth || 400, (window.screen && window.screen.width) || 400);
    if (w <= 430) return 0.66;
    if (w <= 520) return 0.72;
    return 1.00;
  }

  function buildSrc(page){
    const p = normalizePage(page);
    const u = new URL(EXEC);
    u.searchParams.set("p", p);
    u.searchParams.set("embed", "1");
    // IMPORTANT: keep Apps Script scale=1 (we scale in wrapper on ALL devices now)
    u.searchParams.set("scale", "1");
    u.searchParams.set("v", Date.now().toString(36));
    return u.toString();
  }

  // ===== iOS height sync state =====
  let lastContentH = 0;
  let raf = 0;

  function applyIOSLayout(force){
    const s = pickScale();
    root.style.setProperty("--s", String(s));

    const baseH = Math.max(MIN_H, Math.min(MAX_H, lastContentH || Math.max(1800, (window.innerHeight||800) * 2.5)));
    const padUnscaled = Math.ceil(PAD_VISIBLE / s);
    const iframeH = baseH + padUnscaled;

    const spacerH = Math.ceil(iframeH * s);

    if (force || iosFrame.style.height !== (iframeH + "px")) iosFrame.style.height = iframeH + "px";
    if (force || spacer.style.height !== (spacerH + "px")) spacer.style.height = spacerH + "px";
  }

  function scheduleIOS(force){
    if (raf) return;
    raf = (window.requestAnimationFrame || function(fn){ return setTimeout(fn, 16); })(() => {
      raf = 0;
      applyIOSLayout(!!force);
    });
  }

  function requestHeightReports(){
    try { iosFrame.contentWindow.postMessage({ type:"FA_HEIGHT_REQ", on:true }, "*"); } catch(e){}
  }

  function okOrigin(origin){
    return /^https:\/\/script\.google\.com$/.test(origin) ||
           /^https:\/\/script\.googleusercontent\.com$/.test(origin) ||
           /^https:\/\/[a-z0-9-]+\.googleusercontent\.com$/.test(origin);
  }

  window.addEventListener("message", (ev) => {
    const d = ev && ev.data;
    if (!d || typeof d !== "object") return;
    if (!okOrigin(ev.origin)) return;

    // Header nav
    if (d.type === "FA_NAV") {
      const page = normalizePage(d.page);
      const cur = normalizePage(location.hash.slice(1).split("?")[0]);
      if (page !== cur) location.hash = "#" + page;
      else {
        // refresh current
        if (isIOS) iosFrame.src = buildSrc(page);
        else nativeFrame.src = buildSrc(page);
      }
      return;
    }

    // Height reports only used in iOS mode
    if (isIOS && d.type === "FA_HEIGHT") {
      const hRaw = (d.height != null) ? d.height : d.h;
      const h = parseInt(hRaw, 10);
      if (!isFinite(h) || h <= 0) return;
      const clamped = Math.max(MIN_H, Math.min(MAX_H, h));
      if (Math.abs(clamped - lastContentH) < 10) return;
      lastContentH = clamped;
      scheduleIOS(false);
    }
  });

  function loadFromHash(){
    const raw = location.hash.slice(1);
    const page = normalizePage(raw.split("?")[0]);

    // Always compute and apply scale in wrapper
    root.style.setProperty("--s", String(pickScale()));

    if (isIOS) {
      nativeWrap.style.display = "none";
      frameWrap.style.display = "block";

      lastContentH = 0;
      scheduleIOS(true);

      iosFrame.src = buildSrc(page);

      try { frameWrap.scrollTop = 0; } catch(e){}

      const once = () => { requestHeightReports(); iosFrame.removeEventListener("load", once); };
      iosFrame.addEventListener("load", once);
    } else {
      frameWrap.style.display = "none";
      nativeWrap.style.display = "block";

      nativeFrame.src = buildSrc(page);
    }
  }

  window.addEventListener("hashchange", loadFromHash);

  // IMPORTANT: on Android Chrome, resize fires a lot (address bar).
  // We only update scale; we do NOT reload the iframe.
  window.addEventListener("resize", () => {
    root.style.setProperty("--s", String(pickScale()));
    if (isIOS) scheduleIOS(true);
  });

  if (!location.hash) location.hash = "#" + DEFAULT_PAGE;
  loadFromHash();
})();
</script>

<script>
/* ===== DEBUG PANEL (no DevTools needed) =====
   Add ?debug=1 to the Cloudflare URL, e.g.:
   https://flyingaces.lufberydiscgolf.com/?debug=1#matchups
*/
(function(){
  try{
    var qs = new URLSearchParams(location.search || "");
    if (!qs.has("debug")) return;

    function el(tag, css, txt){
      var n = document.createElement(tag);
      if (css) n.style.cssText = css;
      if (txt != null) n.textContent = txt;
      return n;
    }

    var panel = el("div",
      "position:fixed;left:10px;right:10px;bottom:10px;z-index:2147483647;" +
      "background:rgba(0,0,0,.82);color:#fff;border-radius:12px;" +
      "padding:10px 12px;font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;" +
      "box-shadow:0 6px 24px rgba(0,0,0,.35);"
    );

    var title = el("div","font-weight:700;margin-bottom:6px;","FA DEBUG");
    panel.appendChild(title);

    function getMode(){
      var nw = document.getElementById("nativeWrap");
      var iw = document.getElementById("frameWrap");
      if (nw && nw.style.display !== "none") return "ANDROID/DESKTOP native iframe scroll (wrapper scaled)";
      if (iw && iw.style.display !== "none") return "iOS wrapper scroll";
      return "unknown";
    }

    function getScale(){
      var s = getComputedStyle(document.documentElement).getPropertyValue("--s").trim();
      return s || "(n/a)";
    }

    function getIframeSrc(){
      var nf = document.getElementById("nativeFrame");
      var ios = document.getElementById("iosFrame");
      if (nf && nf.src) return nf.src;
      if (ios && ios.src) return ios.src;
      var any = document.querySelector("iframe");
      return any ? (any.src || "(empty)") : "(no iframe found)";
    }

    var row1 = el("div","margin:2px 0;","Mode: " + getMode());
    var row2 = el("div","margin:2px 0;","Scale (--s): " + getScale());
    var row3 = el("div","margin:6px 0 0;word-break:break-all;","Iframe: " + getIframeSrc());
    panel.appendChild(row1); panel.appendChild(row2); panel.appendChild(row3);

    var btnRow = el("div","margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;");
    var copyBtn = el("button",
      "appearance:none;border:0;border-radius:10px;padding:8px 10px;" +
      "background:#2e7dff;color:#fff;font-weight:700;cursor:pointer;",
      "Copy iframe URL"
    );
    var refreshBtn = el("button",
      "appearance:none;border:0;border-radius:10px;padding:8px 10px;" +
      "background:#444;color:#fff;font-weight:700;cursor:pointer;",
      "Refresh values"
    );
    btnRow.appendChild(copyBtn);
    btnRow.appendChild(refreshBtn);
    panel.appendChild(btnRow);

    copyBtn.onclick = async function(){
      var v = getIframeSrc();
      try{
        await navigator.clipboard.writeText(v);
        copyBtn.textContent = "Copied!";
        setTimeout(function(){ copyBtn.textContent = "Copy iframe URL"; }, 900);
      }catch(e){
        window.prompt("Copy iframe URL:", v);
      }
    };

    refreshBtn.onclick = function(){
      row1.textContent = "Mode: " + getMode();
      row2.textContent = "Scale (--s): " + getScale();
      row3.textContent = "Iframe: " + getIframeSrc();
    };

    document.body.appendChild(panel);
  }catch(e){}
})();
</script>

</body>
</html>
