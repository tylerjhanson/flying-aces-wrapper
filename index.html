<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flying Aces</title>
  <style>
    :root { --vh: 1vh; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* wrapper never scrolls; iframe does */
      background: #0b0c10;
    }

    /* Fullscreen iframe */
    #app {
      position: fixed;
      inset: 0;
      width: 100%;
      height: calc(var(--vh) * 100);
      border: 0;
      background: #ffffff;
    }

    @supports (height: 100dvh) {
      #app { height: 100dvh; }
    }

    /* Optional debug overlay */
    #debug {
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.72);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
      line-height: 1.25;
      z-index: 999999;
      display: none;
    }
    #debug .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    #debug code { color: #b7ffb7; word-break: break-all; }
    #debug button {
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <iframe id="app" title="Flying Aces" scrolling="yes"></iframe>

  <div id="debug">
    <div class="row" style="justify-content:space-between">
      <div><b>FA DEBUG</b> — native iframe scroll + iframe viewport scaling</div>
      <div id="dbgScale"></div>
    </div>
    <div style="margin-top:6px">
      <div><b>Page:</b> <span id="dbgPage"></span></div>
      <div><b>Iframe:</b> <code id="dbgSrc"></code></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnCopy">Copy iframe URL</button>
      <button id="btnReload">Reload</button>
    </div>
  </div>

  <script>
    (function () {
      // ✅ Your Apps Script web app exec URL:
      const EXEC = "https://script.google.com/macros/s/AKfycbyD80f8Rq69CMvLVSeTRmCtcj8WGwC-HsdIsYSEZ0b4yIA8TvihUztv9H2wGh4vDSpDaw/exec";

      const ALLOWED = new Set(["rankings", "scoring", "rosters", "matchups"]);
      const DEFAULT_PAGE = "matchups";

      const iframe = document.getElementById("app");
      const debugEl = document.getElementById("debug");
      const dbgScale = document.getElementById("dbgScale");
      const dbgPage = document.getElementById("dbgPage");
      const dbgSrc  = document.getElementById("dbgSrc");

      let currentPage = null;
      let currentScale = null;

      function qs(name) {
        return new URLSearchParams(location.search).get(name);
      }

      // Cache-bust token should be stable for the whole wrapper session.
      // (Mobile browsers fire lots of resize events while scrolling; changing v would force reloads.)
      const SESSION_V = qs("v") || String(Date.now());

      function normalizePage(p) {
        p = String(p || "").trim().toLowerCase();
        if (!p) return DEFAULT_PAGE;
        // allow "#matchups?x=1" etc
        p = p.split("?")[0].split("&")[0].replace(/^#/, "");
        return ALLOWED.has(p) ? p : DEFAULT_PAGE;
      }

      function setVhVar() {
        // keeps height stable with mobile address bar changes
        document.documentElement.style.setProperty("--vh", (window.innerHeight * 0.01) + "px");
      }

      // Source of truth: iframe viewport scale (NOT wrapper transform)
      function pickScale() {
        // Allow manual override: ?scale=0.62 or ?s=0.62 or ?sf=0.62
        const overrideRaw = qs("s") || qs("sf") || qs("scale");
        if (overrideRaw != null) {
          const v = Number(overrideRaw);
          if (Number.isFinite(v) && v >= 0.4 && v <= 1.2) return +v.toFixed(3);
        }

        // Auto scale by viewport width (CSS pixels)
        const w = Math.min(
          window.innerWidth || 9999,
          document.documentElement.clientWidth || 9999,
          screen.width || 9999
        );

        // Phones
        if (w <= 430) return 0.60;   // Pixel 7a / iPhone mini-ish
        if (w <= 520) return 0.66;   // larger phones
        if (w <= 820) return 0.75;   // small tablets / narrow desktop
        return 1.00;                // wide screens
      }

      function buildSrc(page) {
        const p = normalizePage(page);
        const s = pickScale();

        const u = new URL(EXEC);
        u.searchParams.set("p", p);
        u.searchParams.set("embed", "1");
        u.searchParams.set("scale", String(s));

        // Cache-bust only if not provided
        u.searchParams.set("v", SESSION_V);

        return { url: u.toString(), page: p, scale: s };
      }

      function getTargetPage() {
        // Prefer hash routing for the wrapper
        const fromHash = normalizePage((location.hash || "").slice(1));
        // Also accept ?p= for deep links
        const fromQuery = normalizePage(qs("p"));
        return (location.hash && location.hash.length > 1) ? fromHash : fromQuery || DEFAULT_PAGE;
      }

      function updateDebug(url, page, scale) {
        if (debugEl.style.display !== "block") return;
        dbgScale.textContent = "Scale: " + scale;
        dbgPage.textContent = page;
        dbgSrc.textContent = url;
      }

      function navigate(page, forceReload) {
        const built = buildSrc(page);

        // Track + reload only when needed
        const scaleChanged = (currentScale == null) || (Math.abs(built.scale - currentScale) > 0.0005);
        const pageChanged  = (currentPage == null) || (built.page !== currentPage);

        currentPage = built.page;
        currentScale = built.scale;

        if (forceReload || pageChanged || scaleChanged || iframe.src !== built.url) {
          iframe.src = built.url;
        }

        updateDebug(built.url, built.page, built.scale);
      }

      // Listen for nav clicks from inside the Apps Script Header.html
      window.addEventListener("message", (ev) => {
        const d = ev && ev.data;
        if (!d || d.type !== "FA_NAV") return;

        const page = normalizePage(d.page);
        // Keep hash in sync (so back button works)
        if (normalizePage((location.hash || "").slice(1)) !== page) {
          location.hash = "#" + page;
        } else {
          navigate(page, true);
        }
      });

      window.addEventListener("hashchange", () => navigate(getTargetPage(), false));
      let _resizeT = null;
      window.addEventListener("resize", () => {
        setVhVar();
        // Mobile browsers fire many resize events while scrolling (address bar show/hide).
        // Only reload the iframe if the chosen scale actually changes (e.g., orientation / breakpoint).
        clearTimeout(_resizeT);
        _resizeT = setTimeout(() => {
          const next = pickScale();
          if (currentScale == null || Math.abs(next - currentScale) > 0.0005) {
            navigate(currentPage || getTargetPage(), true);
          }
        }, 180);
      });

      // iOS Safari: keep --vh updated when the visual viewport changes (keyboard / address bar)
      if (window.visualViewport) {
        try {
          window.visualViewport.addEventListener("resize", setVhVar);
          window.visualViewport.addEventListener("scroll", setVhVar);
        } catch (e) {}
      }

      // Debug UI toggle: ?debug=1
      if (qs("debug") === "1") {
        debugEl.style.display = "block";
        document.getElementById("btnCopy").onclick = async () => {
          try { await navigator.clipboard.writeText(iframe.src); } catch (e) {}
        };
        document.getElementById("btnReload").onclick = () => navigate(currentPage || getTargetPage(), true);
      }

      // Boot
      setVhVar();
      if (!location.hash && !qs("p")) location.hash = "#" + DEFAULT_PAGE;
      navigate(getTargetPage(), true);
    })();
  </script>
</body>
</html>
