<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="robots" content="noindex, nofollow">
<title>Standings</title>

<style>
/* =========================================================
   1. HEADER STYLES (Literal copy from header.html)
   ========================================================= */
:root{ --fa-header-offset: 0px; }

.fa-header{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #f7f8fa;
  border-bottom: none;
  padding: 0 !important;
  box-sizing: border-box;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

html, body { touch-action: pan-x pan-y; }

.fa-header .fa-tabs{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px !important;
  padding: 8px 0 !important;
  margin: 0 !important;
  border: none !important;
  background: transparent !important;
  border-radius: 0 !important;
}

.fa-header .fa-tabs button,
.fa-header .fa-submenu button{
  -webkit-appearance:none !important;
  appearance:none !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  width:100% !important;
  box-sizing:border-box !important;
  font-family:"Segoe UI", Roboto, Arial, sans-serif !important;
  font-weight:900 !important;
  font-size: clamp(12px, 3.6vw, 16px) !important;
  letter-spacing: .2px !important;
  line-height: 1 !important;
  height: 40px !important;
  min-height: 40px !important;
  padding: 0 6px !important;
  border-radius: 8px !important;
  border: 0 !important;
  outline: none !important;
  background: linear-gradient(180deg, #f9f9f9 0%, #ededed 100%) !important;
  box-shadow: 0 1px 4px rgba(0,0,0,.10) !important;
  color: #222 !important;
  cursor: pointer !important;
  transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease, filter .12s ease !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  -webkit-tap-highlight-color: transparent !important;
  user-select: none !important;
}

.fa-header .fa-tabs button:not(.active):hover,
.fa-header .fa-submenu button:not(.sub-active):hover{
  background: linear-gradient(180deg, #f1f1f1 0%, #e3e7f0 100%) !important;
}

.fa-header .fa-tabs button.active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

.fa-header .fa-tabs button.fa-press,
.fa-header .fa-submenu button.fa-press{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

.fa-header .fa-tabs button:active,
.fa-header .fa-submenu button:active{ transform: scale(0.99); }

#nav-menu{
  padding: 0 10px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
}

#nav-menu .menu-logo{ height: 18px; width: auto; display: block; }
#nav-menu .hamburger-icon{ width: 24px; height: 24px; flex: 0 0 auto; }

.fa-submenu-wrap{ position: relative; }

.fa-submenu{
  position: absolute;
  top: 100%;
  left: 0;
  padding: 8px 0 0;
  z-index: 1001;
  opacity: 0;
  transform: translateY(-6px);
  visibility: hidden;
  pointer-events: none;
  transition: opacity 140ms ease, transform 140ms ease, visibility 0s linear 140ms;
}

.fa-submenu.show{
  opacity: 1;
  transform: translateY(0);
  visibility: visible;
  pointer-events: auto;
  transition: opacity 140ms ease, transform 140ms ease;
}

.fa-submenu .inner{
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 12px 26px rgba(0,0,0,.16);
  border-radius: 14px;
  overflow: hidden;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.fa-header .fa-submenu button{ height: 42px !important; min-height: 42px !important; font-size: 13px !important; border-radius: 12px !important; }

.fa-header .fa-submenu button.sub-active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color:#fff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.04);
}

@media (max-width: 420px){
  .fa-header .fa-tabs button{ height: 36px !important; min-height: 36px !important; font-size: 13px !important; }
  .fa-header .fa-submenu button{ height: 40px !important; min-height: 40px !important; font-size: 12.5px !important; }
  #nav-menu .menu-logo{ height: 16px; }
  #nav-menu .hamburger-icon{ width: 22px; height: 22px; }
}

/* =========================================================
   2. STANDINGS STYLES (Literal copy from text file)
   ========================================================= */
:root{ font-size: 12.5px; --btn-angle:135deg; }

html, body{
  margin:0; padding:0;
  background:#f7f8fa; color:#222;
  font-family:"Segoe UI", Roboto, Arial, sans-serif;
  -webkit-text-size-adjust:100%;
  text-size-adjust:100%;
}

body{
  padding:12px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
  overflow-x:hidden;
}

.panel{
  background:#fff;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  padding:14px;
  margin:12px 0;
}

.h2{ font-size:14px; font-weight:950; margin:0 0 10px; text-transform:uppercase; letter-spacing:.02em; }
.small{ font-size:11px; color:#667085; font-weight:800; }

.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
thead th{
  font-size:11px;
  letter-spacing:.06em;
  color:#4b5563;
  padding:10px 10px;
  border-bottom:1px solid #eef2f7;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  text-transform:uppercase;
  text-align:center;
}
tbody td{
  padding:10px 10px;
  border-bottom:1px solid #f1f5f9;
  font-size:13px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
tbody td:first-child{ text-align:left; }
thead th:nth-child(n+2),
tbody td:nth-child(n+2){ text-align:center; }

.pill{
  display:inline-flex;
  align-items:center;
  padding:4px 9px;
  border-radius:999px;
  background:#f1f5f9;
  font-weight:900;
  color:#111827;
  font-size:11.5px;
}

.panel-titlebar{
  display:flex;
  align-items:center;
  justify-content:center;
  margin:-14px -14px 12px;
  height:32px;
  padding:0 14px;
  box-sizing:border-box;
  text-transform:uppercase;
  font-weight:950;
  font-size:14px;
  letter-spacing:.02em;
  user-select:none;
  background: linear-gradient(var(--btn-angle), #ff3b3b, #e40000);
  color:#fff;
  border-top-left-radius:18px;
  border-top-right-radius:18px;
}

details.collapsible{ padding:0; }
details.collapsible > summary{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px 14px;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  font-weight:950;
  font-size:14px;
  letter-spacing:.02em;
  text-transform:uppercase;
  position:relative;
  list-style:none;
}
details.collapsible > summary::-webkit-details-marker{ display:none; }
.collap-chevron{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%) rotate(0deg);
  transition: transform 180ms ease;
  font-size:18px;
  color:#667085;
}
details.collapsible[open] .collap-chevron{ transform: translateY(-50%) rotate(180deg); }
.collap-body{ padding:0 14px 14px; }
.detailsBody{ padding:0 14px 14px; }

.match-card{
  background:#fff;
  border:1px solid #eef2f7;
  border-radius:16px;
  padding:8px 10px;
  display:grid;
  grid-template-columns: 1fr 86px 1fr;
  gap:8px;
  align-items:center;
  font-weight: 400;
}

.match-card.score-win{
  box-shadow: inset 6px 0 0 rgba(21,128,61,.22), inset -6px 0 0 rgba(185,28,28,.18);
}
.match-card.score-loss{
  box-shadow: inset 6px 0 0 rgba(185,28,28,.18), inset -6px 0 0 rgba(21,128,61,.22);
}
.match-card.score-tie{
  box-shadow: inset 6px 0 0 rgba(161,98,7,.18), inset -6px 0 0 rgba(161,98,7,.18);
}

.elo-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid #e7edf5;
  background:#f8fafc;
  color:#475569;
  font-size:11px;
  font-weight:900;
  margin-top:4px;
}
.elo-pill.pill-win{ border-color: rgba(21,128,61,.28); background: rgba(21,128,61,.10); color:#14532d; }
.elo-pill.pill-loss{ border-color: rgba(185,28,28,.28); background: rgba(185,28,28,.10); color:#7f1d1d; }
.elo-pill.pill-tie{ border-color: rgba(161,98,7,.28); background: rgba(161,98,7,.10); color:#78350f; }

.match-card + .match-card{ margin-top:10px; }

.mc-left, .mc-right{ min-width:0; font-weight: inherit; }
.mc-left{ text-align:left; }
.mc-right{ text-align:right; }

.mc-name{
  line-height:1.12;
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
  min-width:0;
}
.mc-left .mc-name{ justify-content:flex-start; }
.mc-right .mc-name{ justify-content:flex-end; }
.mc-name .nm{ min-width:0; overflow:hidden; text-overflow:ellipsis; font-weight:900; }

.mc-mid{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  font-weight: 700;
}
.mc-score{
  font-weight:900;
  text-align:center;
  border-radius:12px;
  padding:4px 6px;
  min-width:68px;
  border:1px solid #eef2f7;
  background:#f8fafc;
  line-height:1;
  font-size:11.5px;
  color:#334155;
}

.mc-date-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #eef2f7;
  background:#f8fafc;
  font-weight:900;
  font-size:12px;
  color:#334155;
  line-height:1;
}
.mc-score-stroke{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  font-size:15px;
}
@media (max-width: 420px){ .mc-score-stroke{ font-size:14px; } }

.adj-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media (max-width: 640px){ .adj-grid{ grid-template-columns: 1fr; } }

#adjWrap input, #adjWrap select, #adjWrap button{ box-sizing:border-box; max-width:100%; }

.mc-date-pill{ background: transparent !important; border: none !important; padding: 0 !important; border-radius: 0 !important; box-shadow: none !important; display: block !important; }
.mc-score{ background: transparent !important; border: none !important; padding: 0 !important; min-width: 0 !important; border-radius: 0 !important; box-shadow: none !important; font-size: 16px !important; line-height: 1.1 !important; }
.mc-scoreline .score-win, .mc-score .score-win{ color:#15803d !important; }
.mc-scoreline .score-loss, .mc-score .score-loss{ color:#b91c1c !important; }
.mc-scoreline .score-tie, .mc-score .score-tie{ color:#a16207 !important; }
.mc-name .score-win, .mc-name .score-loss, .mc-name .score-tie{ color:#111 !important; }
.mc-side-team{ color:#111 !important; }

thead th:nth-child(2),
thead th:nth-child(3),
tbody td:nth-child(2),
tbody td:nth-child(3){ padding-left:6px; padding-right:6px; }

/* Pull-to-refresh styles from header.html */
#fa-ptr{
  position: fixed;
  left: 50%;
  top: calc(env(safe-area-inset-top) + 10px);
  transform: translate(-50%, -14px);
  opacity: 0;
  z-index: 99999;
  pointer-events: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 18px rgba(0,0,0,.12);
  transition: opacity 140ms ease, transform 140ms ease;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
#fa-ptr.show{ opacity: 1; transform: translate(-50%, 0); }
#fa-ptr .spin{
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,.18);
  border-top-color: rgba(0,0,0,.55);
  animation: faSpin 800ms linear infinite;
}
@keyframes faSpin { to { transform: rotate(360deg); } }
</style>
</head>

<body>
<div class="fa-header fa-submenu-wrap">
  <nav class="fa-tabs">
    <button id="nav-scoring"  type="button" data-page="scoring">SCORING</button>
    <button id="nav-rosters"  type="button" data-page="rosters">ROSTERS</button>
    <button id="nav-matchups" type="button" data-page="matchups">MATCHUPS</button>
    <button id="nav-menu" type="button" data-key="menu" aria-expanded="false" aria-label="More">
      <img
        class="menu-logo"
        src="https://lufberydiscgolf.com/wp-content/uploads/2025/05/lufberyflyingace_logo-1.png?w=64&h=32"
        alt=""
        aria-hidden="true"
        loading="eager"
        decoding="async"
      />
      <svg class="hamburger-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
      </svg>
    </button>
  </nav>

  <div class="fa-submenu" id="faMoreMenu" aria-hidden="true">
    <div class="inner">
      <button data-page="rankings">RANKINGS</button>
      <button data-page="stats">STATS</button>
      <button data-page="elo">ELO</button>
      <button data-page="standings">STANDINGS</button>
      <button data-page="admin">ADMIN</button>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-titlebar">STANDINGS</div>
  <div class="table-wrap" style="margin-top:10px;">
    <table>
      <colgroup>
        <col style="width:56%;">
        <col style="width:8%;">
        <col style="width:8%;">
        <col style="width:28%;">
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:left;">TEAM</th>
          <th>W</th>
          <th>L</th>
          <th>POINTS %</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="4" class="small" style="padding:14px;">Loading…</td></tr>
      </tbody>
    </table>
    <div id="meta" class="small" style="margin-top:10px;"></div>
  </div>
</div>

<details class="panel collapsible" id="matchResults">
  <summary>MATCH RESULTS<span class="collap-chevron">▾</span></summary>
  <div class="collap-body"><div id="results"></div></div>
</details>

<details class="panel collapsible" id="bigUpsets">
  <summary>BIGGEST UPSETS<span class="collap-chevron">▾</span></summary>
  <div class="collap-body"><div id="upsets"></div></div>
</details>

<details class="panel collapsible" id="simMatchup">
  <summary>SIMULATE MATCHUP<span class="collap-chevron">▾</span></summary>
  <div class="collap-body">
    <div class="adj-grid">
      <div><select id="simTeamA" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900; background:#fff;"></select></div>
      <div><select id="simTeamB" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900; background:#fff;"></select></div>
    </div>
    <div id="simOut" style="margin-top:10px;"></div>
  </div>
</details>

<details class="panel collapsible" id="adjWrap">
  <summary>PENALTY POINTS<span class="collap-chevron">▾</span></summary>
  <div class="collap-body">
    <div style="margin-top:10px; border-top:1px solid #eef2f7; padding-top:10px;">
      <div class="adj-grid">
        <div><div class="small">Date</div><input id="adjDate" type="date" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900;"></div>
        <div><div class="small">Add penalty points</div><select id="adjTeam" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900; background:#fff;"></select></div>
        <div><div class="small">Opponent team</div><select id="adjOpp" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900; background:#fff;"></select></div>
        <div><div class="small">Penalty Points</div><input id="adjDelta" placeholder="4" inputmode="decimal" style="width:100%; padding:10px 10px; border:1px solid #e6edf5; border-radius:12px; font-weight:900;"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
        <button id="adjSave" style="border:0; border-radius:14px; padding:10px 14px; font-weight:1000; color:#fff; background:linear-gradient(var(--btn-angle), #ff3b3b, #e40000);">SAVE</button>
        <div class="small" id="adjMsg"></div>
      </div>
      <div style="margin-top:12px; border-top:1px solid #eef2f7; padding-top:12px;"><div id="adjList" class="small" style="padding:6px 2px;"></div></div>
    </div>
  </div>
</details>

<script>
/* =========================================================
   5. SCRIPTS (Standings logic merged with Header navigation)
   ========================================================= */
const $ = (id)=>document.getElementById(id);
function esc(s){ return (s==null?"":String(s)).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }
function dispTeamName(s){ return String(s||"").replace(/^OPP\s*-\s*/i,"").trim(); }
function normTeam(s){ return dispTeamName(s).toLowerCase().replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim(); }

function pointsForMode(mode){
  mode = String(mode||"").toLowerCase().trim();
  if (mode === "singles") return 1;
  if (mode === "doubles") return 2;
  if (mode === "triples") return 3;
  return 0;
}
function pointsSplit(mode){ const p = pointsForMode(mode); return p ? (p/2) : 0; }
function fmtPts(x){
  const n = Number(x||0);
  if (!isFinite(n)) return "0";
  const v = Math.round(n*10)/10;
  if (Math.abs(v - Math.round(v)) < 1e-9) return String(Math.round(v));
  let s = v.toFixed(1);
  if (s.endsWith(".0")) s = s.slice(0,-2);
  return s;
}

function parseDateKey(ts){
  const s = String(ts||"").trim();
  if (!s) return "";
  let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (m) return `${m[3]}-${m[1].padStart(2,"0")}-${m[2].padStart(2,"0")}`;
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})/);
  if (m){
    const mm = m[1].padStart(2,"0"), dd = m[2].padStart(2,"0"), y2 = Number(m[3]);
    const yy = (y2 <= 79) ? (2000 + y2) : (1900 + y2);
    return `${yy}-${mm}-${dd}`;
  }
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m2) return `${m2[1]}-${m2[2]}-${m2[3]}`;
  const d = new Date(s);
  if (!isNaN(d.getTime())){
    const yy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,"0"), dd = String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }
  return "";
}

function fmtDateShort(dk){
  const m = String(dk||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return dk || "";
  return `${Number(m[2])}/${Number(m[3])}/${m[1].slice(2)}`;
}

function pickOrder(team1, team2){
  const a = team1.name, b = team2.name;
  if (/flying\s*aces/i.test(a) && !/flying\s*aces/i.test(b)) return [team2.key, team1.key];
  if (/flying\s*aces/i.test(b) && !/flying\s*aces/i.test(a)) return [team1.key, team2.key];
  return (a.localeCompare(b) <= 0) ? [team1.key, team2.key] : [team2.key, team1.key];
}

function computeFromMatchLog(rows, adjustments){
  const teamTotals = new Map(), matchups = new Map(), adjMap = new Map();
  for (const a of (adjustments||[])){
    const dk = parseDateKey(a.dateKey || a.dateDisp || ""), t1 = normTeam(a.team||""), t2 = normTeam(a.opp||"");
    if (!dk || !t1 || !t2) continue;
    const pair = [t1,t2].sort().join("|"), key = dk + "|" + pair;
    if (!adjMap.has(key)) adjMap.set(key, []);
    adjMap.get(key).push({ teamKey: t1, delta: Number(a.delta||0) });
  }
  function ensureLeagueTeam(teamKey, teamName){
    if (!teamTotals.has(teamKey)) teamTotals.set(teamKey, { key:teamKey, team:teamName, w:0, l:0, t:0, points:0, possible:0 });
    return teamTotals.get(teamKey);
  }
  function ensureMatchup(dateKey, keyA, nameA, keyB, nameB){
    const pair = [keyA, keyB].sort().join("|"), k = (dateKey || "unknown") + "|" + pair;
    if (!matchups.has(k)) matchups.set(k, { dateKey: dateKey || "unknown", teams: new Map([[keyA, { key:keyA, name:nameA, pts:0, possible:0 }],[keyB, { key:keyB, name:nameB, pts:0, possible:0 }]])});
    else {
      const g = matchups.get(k);
      if (!g.teams.has(keyA)) g.teams.set(keyA, { key:keyA, name:nameA, pts:0, possible:0 });
      if (!g.teams.has(keyB)) g.teams.set(keyB, { key:keyB, name:nameB, pts:0, possible:0 });
    }
    return matchups.get(k);
  }
  for (const r of (rows||[])){
    const tAraw = r.teamA ?? r["Team A"] ?? r.team_a ?? "", tBraw = r.teamB ?? r["Team B"] ?? r.team_b ?? "";
    const mode = (r.mode ?? r.Mode ?? "").toString().toLowerCase().trim(), result = (r.result ?? r.Result ?? "").toString().toUpperCase().trim(), ts = r.timestamp ?? r.Timestamp ?? "";
    if (!tAraw || !tBraw) continue;
    const pWin = pointsForMode(mode); if (!pWin) continue;
    const dk = parseDateKey(ts), nA = dispTeamName(tAraw), nB = dispTeamName(tBraw), kA = normTeam(tAraw), kB = normTeam(tBraw);
    ensureLeagueTeam(kA, nA); ensureLeagueTeam(kB, nB);
    const g = ensureMatchup(dk, kA, nA, kB, nB), A = g.teams.get(kA), B = g.teams.get(kB);
    A.possible += pWin; B.possible += pWin;
    if (result === "W") A.pts += pWin; else if (result === "L") B.pts += pWin; else { const half = pointsSplit(mode); A.pts += half; B.pts += half; }
  }
  const matchupList = [];
  for (const [key, g] of matchups.entries()){
    const teamArr = Array.from(g.teams.values()); if (teamArr.length < 2) continue;
    let [leftKey, rightKey] = pickOrder(teamArr[0], teamArr[1]), L = g.teams.get(leftKey), R = g.teams.get(rightKey);
    const adjList = adjMap.get(key) || []; let la = 0, ra = 0, pa = 0;
    for (const ad of adjList){ const d = Number(ad.delta||0); pa += Math.abs(d); if (ad.teamKey === L.key) la += d; else if (ad.teamKey === R.key) ra += d; }
    L.pts += la; R.pts += ra; L.possible += pa; R.possible += pa;
    if (R.pts > L.pts) { const tmp = L; L = R; R = tmp; }
    else if (R.pts === L.pts && String(R.name).localeCompare(String(L.name)) < 0) { const tmp = L; L = R; R = tmp; }
    const LT = ensureLeagueTeam(L.key, L.name), RT = ensureLeagueTeam(R.key, R.name);
    LT.points += L.pts; LT.possible += L.possible; RT.points += R.pts; RT.possible += R.possible;
    if (L.pts > R.pts) { LT.w++; RT.l++; } else if (R.pts > L.pts) { LT.l++; RT.w++; } else { LT.t++; RT.t++; }
    matchupList.push({ dateKey: g.dateKey, dateShort: fmtDateShort(g.dateKey), leftTeam: L.name, rightTeam: R.name, leftPts: L.pts, rightPts: R.pts, cls: (L.pts > R.pts) ? "score-win" : (R.pts > L.pts) ? "score-loss" : "score-tie" });
  }
  const standings = Array.from(teamTotals.values()).map(s=>{
    const games = s.w + s.l + s.t;
    return { team:s.team, key:s.key, w:s.w, l:s.l, t:s.t, points:s.points, possible:s.possible, winPct: games ? ((s.w + 0.5*s.t) / games) : 0, pointsPct: s.possible ? (s.points / s.possible) : 0 };
  });
  standings.sort((a,b)=> (b.winPct - a.winPct) || (b.pointsPct - a.pointsPct) || (b.points - a.points) || a.team.localeCompare(b.team));
  matchupList.sort((a,b)=> (b.dateKey || "").localeCompare(a.dateKey || "") || (a.leftTeam + " vs " + a.rightTeam).localeCompare(b.leftTeam + " vs " + b.rightTeam));
  return { standings, matchupList, matchupCount: matchupList.length, dateCount: new Set(matchupList.map(m=>m.dateKey)).size };
}

function fillTeamDropdowns(standingsRows){
  const tSel = $("adjTeam"), oSel = $("adjOpp"); if (!tSel || !oSel) return;
  const teams = (standingsRows || []).map(r=>dispTeamName(r.team)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  function setOptions(sel){
    sel.innerHTML = "<option value=''>Select team…</option>";
    teams.forEach(t=>{ const o = document.createElement("option"); o.value = t; o.textContent = t; sel.appendChild(o); });
  }
  setOptions(tSel); setOptions(oSel);
  tSel.addEventListener("change", ()=>{ const tv = tSel.value; Array.from(oSel.options).forEach(o=>{ o.disabled = (tv && o.value === tv); }); if (oSel.value === tv) oSel.value = ""; });
}

let _teamEloMap = Object.create(null), _teamEloLoaded = false, _lastMatchups = [];
function eloWinProb(eloA, eloB){ return 1 / (1 + Math.pow(10, (Number(eloB) - Number(eloA)) / 125)); }
function fmtPct(p){ return (Math.round(Number(p)*1000)/10).toFixed(1) + "%"; }
function fmtElo(n){ return isFinite(Number(n)) ? String(Math.round(n)) : "—"; }

function fillSimTeamSelects(standingsRows){
  const selA = $("simTeamA"), selB = $("simTeamB"); if (!selA || !selB) return;
  const teams = (standingsRows||[]).map(r=>dispTeamName(r.team)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const prevA = selA.value || localStorage.getItem("fa_simA") || "", prevB = selB.value || localStorage.getItem("fa_simB") || "";
  function setOpts(sel){
    sel.innerHTML = "<option value=''>Select team…</option>";
    teams.forEach(t=>{ const o = document.createElement("option"); o.value = t; o.textContent = t; sel.appendChild(o); });
  }
  setOpts(selA); setOpts(selB);
  selA.value = teams.includes(prevA) ? prevA : ""; selB.value = teams.includes(prevB) ? prevB : "";
  function enforce(){ const a = selA.value; Array.from(selB.options).forEach(o=>{ o.disabled = (a && o.value === a); }); if (selB.value === a) selB.value = ""; updateSimOut(); if (_lastMatchups.length) renderUpsets(_lastMatchups); }
  selA.onchange = ()=>{ localStorage.setItem("fa_simA", selA.value||""); enforce(); };
  selB.onchange = ()=>{ localStorage.setItem("fa_simB", selB.value||""); updateSimOut(); };
  enforce();
}

function loadTeamEloAverages(){
  if (_teamEloLoaded) return; _teamEloLoaded = true;
  if ($("simOut")) $("simOut").innerHTML = `<div class="small">Loading team Elo…</div>`;
  runGs("faGetTeamEloAverages_v1", { includeInactive:false }).then(res=>{
    const rows = res.rows || []; _teamEloMap = Object.create(null);
    rows.forEach(r=>{ if (r.team && isFinite(r.avgElo)) _teamEloMap[normTeam(r.team)] = Number(r.avgElo); });
    updateSimOut(); if (_lastMatchups.length) renderUpsets(_lastMatchups);
  }).catch(e=>{ console.error(e); if ($("simOut")) $("simOut").innerHTML = `<div class="small">Couldn’t load team Elo.</div>`; });
}

function updateSimOut(){
  const out = $("simOut"), sA = $("simTeamA"), sB = $("simTeamB"); if (!out || !sA || !sB) return;
  const a = sA.value, b = sB.value; if (!a || !b){ out.innerHTML = `<div class="small">Pick two teams.</div>`; return; }
  const eA = _teamEloMap[normTeam(a)], eB = _teamEloMap[normTeam(b)];
  if (!isFinite(eA) || !isFinite(eB)){ out.innerHTML = `<div class="small">Elo missing for one or both.</div>`; return; }
  const pA = eloWinProb(eA, eB), pB = 1 - pA;
  const hi = `background:#ecfdf3; border-color:#bbf7d0; color:#15803d;`, lo = `background:#fef2f2; border-color:#fecaca; color:#b91c1c;`, tie = `background:#f8fafc; border-color:#e2e8f0; color:#334155;`;
  out.innerHTML = `
    <div class="match-card score-tie" style="grid-template-columns: 1fr 86px 1fr;">
      <div class="mc-left"><div class="mc-side-team">${esc(a)}</div><div class="elo-pill">ELO ${fmtElo(eA)}</div><div class="elo-pill" style="${(pA>pB)?hi:(pB>pA)?lo:tie}">WIN ${fmtPct(pA)}</div></div>
      <div class="mc-mid"><div class="mc-score">VS</div></div>
      <div class="mc-right"><div class="mc-side-team">${esc(b)}</div><div class="elo-pill">ELO ${fmtElo(eB)}</div><div class="elo-pill" style="${(pB>pA)?hi:(pA>pB)?lo:tie}">WIN ${fmtPct(pB)}</div></div>
    </div>`;
}

function renderStandings(rows){
  const tb = $("body"); tb.innerHTML = "";
  if (!rows.length){ tb.innerHTML = "<tr><td colspan='4' class='small' style='padding:14px;'>No matches yet.</td></tr>"; return; }
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style='font-weight:950; text-align:left;'>${esc(dispTeamName(r.team))}</td><td>${Number(r.w||0)}</td><td>${Number(r.l||0)}</td><td style='font-weight:950;'><span class='pill'>${(Math.round(Number(r.pointsPct)*10000)/100).toFixed(2)}%</span></td>`;
    tb.appendChild(tr);
  });
}

function renderMatchups(matchups){
  const root = $("results"); if (!root) return; root.innerHTML = "";
  if (!matchups.length){ root.innerHTML = "<div class='small'>No matchups found.</div>"; return; }
  matchups.forEach(m=>{
    const c = document.createElement("div"); c.className = "match-card " + m.cls;
    const lC = (m.leftPts > m.rightPts) ? "score-win" : (m.rightPts > m.leftPts) ? "score-loss" : "score-tie", rC = (m.rightPts > m.leftPts) ? "score-win" : (m.leftPts > m.rightPts) ? "score-loss" : "score-tie";
    c.innerHTML = `<div class='mc-left'><span class='nm'>${esc(m.leftTeam)}</span></div><div class='mc-mid'><div class='mc-date-pill'>${esc(m.dateShort)}</div><div class='mc-score mc-score-stroke'><span class='${lC}'>${fmtPts(m.leftPts)}</span><span style='opacity:.5;'>–</span><span class='${rC}'>${fmtPts(m.rightPts)}</span></div></div><div class='mc-right'><span class='nm'>${esc(m.rightTeam)}</span></div>`;
    root.appendChild(c);
  });
}

function renderUpsets(matchups){
  const root = $("upsets"); if (!root || !_teamEloLoaded || !matchups.length) return;
  const byDate = new Map(); matchups.forEach(m=>{ const dk = String(m.dateKey || "").trim() || "unknown"; if (!byDate.has(dk)) byDate.set(dk, []); byDate.get(dk).push(m); });
  const dates = Array.from(byDate.keys()).sort(), elo = Object.create(null), upsets = [];
  function getE(name){ const k = normTeam(name); if (!elo[k]) elo[k] = _teamEloMap[k] || 1500; return elo[k]; }
  dates.forEach(dk=>{
    const gs = byDate.get(dk), ds = Object.create(null);
    gs.forEach(m=>{
      const lT = m.leftTeam, rT = m.rightTeam, kL = normTeam(lT), kR = normTeam(rT), eL = getE(lT), eR = getE(rT), pL = eloWinProb(eL, eR), lp = Number(m.leftPts), rp = Number(m.rightPts);
      let sL = 0.5; if (lp > rp) sL = 1; else if (lp < rp) sL = 0;
      if (sL !== 0.5){ const won = (sL === 1), pW = won ? pL : (1 - pL); if (pW < 0.5) upsets.push({ dateKey: dk, dateShort: m.dateShort, leftTeam: won ? lT : rT, rightTeam: won ? rT : lT, leftPts: won ? lp : rp, rightPts: won ? rp : lp, pWin: pW }); }
      const dL = 14 * (sL - pL); ds[kL] = (ds[kL] || 0) + dL; ds[kR] = (ds[kR] || 0) - dL;
    });
    for (const k in ds){ elo[k] = (elo[k] || 1500) + ds[k]; }
  });
  let h = "<div style='display:grid; gap:10px;'>"; upsets.sort((a,b)=> a.pWin - b.pWin).slice(0, 10).forEach((u, i)=>{
    h += `<div class='match-card score-win'><div class='mc-left'><span class='nm'>${esc(u.leftTeam)}</span></div><div class='mc-mid'><div class='mc-date-pill'>${esc(u.dateShort)}</div><div class='mc-score mc-score-stroke'><span class='score-win'>${fmtPts(u.leftPts)}</span><span style='opacity:.5;'>–</span><span class='score-loss'>${fmtPts(u.rightPts)}</span></div><div class='small' style='font-weight:950;'>#${i+1} • WIN ${fmtPct(u.pWin)}</div></div><div class='mc-right'><span class='nm'>${esc(u.rightTeam)}</span></div></div>`;
  });
  root.innerHTML = h + "</div>";
}

function renderAdjustments(rows){
  const el = $("adjList"); if (!el) return; if (!rows.length){ el.innerHTML = "No adjustments yet."; return; }
  let h = "<div style='display:grid; gap:8px;'>"; rows.sort((a,b)=> (a.dateKey||"").localeCompare(b.dateKey||"")).forEach(r=>{
    const dk = parseDateKey(r.dateKey || r.dateDisp), line = `${fmtDateShort(dk)} • ${r.team} vs ${r.opp} • ${(r.delta >= 0 ? "+" : "")}${fmtPts(r.delta)}`;
    h += `<div style='border:1px solid #eef2f7; border-radius:14px; padding:10px; background:#fff;'><div style='display:flex; justify-content:space-between; gap:10px;'><div style='font-weight:950;'>${esc(line)}</div><div style='display:flex; gap:8px;'><button data-edit='${r.id}' style='border:1px solid #e6edf5; background:#fff; border-radius:12px; padding:7px 10px; font-weight:950;'>Edit</button><button data-del='${r.id}' style='border:1px solid rgba(185,28,28,.25); background:rgba(185,28,28,.07); color:#7f1d1d; border-radius:12px; padding:7px 10px; font-weight:950;'>Delete</button></div></div></div>`;
  });
  el.innerHTML = h + "</div>";
  el.querySelectorAll("button[data-edit]").forEach(b=>{ b.onclick = ()=>{ const r = rows.find(x=> String(x.id) === b.dataset.edit); if (r){ $("adjDate").value = parseDateKey(r.dateKey || r.dateDisp); $("adjTeam").value = r.team; $("adjOpp").value = r.opp; $("adjDelta").value = r.delta; $("adjSave").setAttribute("data-id", r.id); $("adjMsg").textContent = "Editing…"; } }; });
  el.querySelectorAll("button[data-del]").forEach(b=>{ b.onclick = async ()=>{ if (!id) return; $("adjMsg").textContent = "Deleting…"; const res = await runGs("faDeleteStandingsAdjustment_v1", { id: b.dataset.del }); if (res.ok) await reloadAdjustmentsAndRecalc(); }; });
}

async function reloadAdjustmentsAndRecalc(){
  const [adjRaw, logRaw] = await Promise.all([runGs("faGetStandingsAdjustments_v1", {}), runGs("faGetMatchLogRows_v1", {})]);
  let adj = adjRaw, log = logRaw; try{ if (typeof adj === "string") adj = JSON.parse(adj); if (typeof log === "string") log = JSON.parse(log); }catch(_){}
  const aR = (adj && adj.ok) ? (adj.rows || []) : [], lR = (log && log.ok) ? (log.rows || []) : [];
  renderAdjustments(aR); const c = computeFromMatchLog(lR, aR); _lastMatchups = c.matchupList; renderStandings(c.standings, c.matchupCount); fillTeamDropdowns(c.standings); initSimulator(c.standings); renderMatchups(_lastMatchups); renderUpsets(_lastMatchups);
}

function wireAdjustmentForm(){
  const saveBtn = $("adjSave"); if (!saveBtn) return;
  saveBtn.onclick = async ()=>{
    const id = saveBtn.getAttribute("data-id") || "", dk = $("adjDate").value, tm = $("adjTeam").value, op = $("adjOpp").value, dl = Number($("adjDelta").value);
    if (!dk || !tm || !op || !isFinite(dl)) { $("adjMsg").textContent = "Fill all fields."; return; }
    $("adjMsg").textContent = "Saving…";
    const res = await runGs("faUpsertStandingsAdjustment_v1", { id, dateDisp: fmtDateShort(dk), team: tm, opp: op, delta: dl, note: "" });
    if (res.ok){ $("adjMsg").textContent = "Saved."; $("adjSave").removeAttribute("data-id"); $("adjDate").value = $("adjTeam").value = $("adjOpp").value = $("adjDelta").value = ""; await reloadAdjustmentsAndRecalc(); }
  };
}

const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxlyif58qdt0l90lSvHOm0TxlPffdfMqajwzhGDQlddsNNn82Bg37CGoMpjBKBuZoNK/exec";
async function runGs(fn, args) {
  try {
    const res = await fetch(GAS_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: fn, payload: args || {} }) });
    const data = await res.json(); if (!data.ok) throw new Error(data.error); return data.result;
  } catch (err) { console.error(err); throw err; }
}

function navigate(page){ window.location.href = page + ".html" + (new URLSearchParams(window.location.search).toString() ? "?" + new URLSearchParams(window.location.search).toString() : ""); }
function toggleMenu(){ const m = $("faMoreMenu"); if (m.classList.contains("show")) { m.classList.remove("show"); m.setAttribute("aria-hidden","true"); } else { m.classList.add("show"); m.setAttribute("aria-hidden","false"); } }
document.addEventListener("click", (e)=>{ const m = $("faMoreMenu"), b = $("nav-menu"); if (!m.classList.contains("show")) return; if (e.target === b || b.contains(e.target) || m.contains(e.target)) return; toggleMenu(); }, true);

async function load(){
  try{
    const cachedLog = localStorage.getItem("fa_cache_log"), cachedAdj = localStorage.getItem("fa_cache_adj");
    if (cachedLog){
      try{
        let log = JSON.parse(cachedLog), adj = cachedAdj ? JSON.parse(cachedAdj) : {rows: []};
        const aR = (adj && adj.ok) ? (adj.rows || []) : [], lR = log.rows || [];
        const c = computeFromMatchLog(lR, aR); _lastMatchups = c.matchupList;
        renderStandings(c.standings, c.matchupCount); fillTeamDropdowns(c.standings); initSimulator(c.standings); renderMatchups(_lastMatchups); renderUpsets(_lastMatchups); renderAdjustments(aR); wireAdjustmentForm();
      } catch(e){}
    }
    const [logRaw, adjRaw] = await Promise.all([runGs("faGetMatchLogRows_v1", {}), runGs("faGetStandingsAdjustments_v1", {})]);
    let log = logRaw, adj = adjRaw; try{ if (typeof log === "string") log = JSON.parse(log); if (typeof adj === "string") adj = JSON.parse(adj); }catch(_){}
    localStorage.setItem("fa_cache_log", JSON.stringify(log)); localStorage.setItem("fa_cache_adj", JSON.stringify(adj));
    const aR = (adj && adj.ok) ? (adj.rows || []) : [], lR = log.rows || [];
    const c = computeFromMatchLog(lR, aR); _lastMatchups = c.matchupList;
    renderStandings(c.standings, c.matchupCount); fillTeamDropdowns(c.standings); initSimulator(c.standings); renderMatchups(_lastMatchups); renderUpsets(_lastMatchups); renderAdjustments(aR); wireAdjustmentForm();
  }catch(err){ if ($("meta")) $("meta").textContent = "Load failed: " + err; }
}

(function(){
  ['gesturestart','gesturechange','gestureend'].forEach((evt)=>{ document.addEventListener(evt, (e)=>{ e.preventDefault(); }, { passive:false }); });
  var lastTouchEnd = 0;
  document.addEventListener('touchend', (e)=>{ if (!!(e.target && e.target.closest && e.target.closest("button,a,input,select,textarea"))) return; var now = Date.now(); if (now - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = now; }, { passive:false });
})();

load();

document.querySelectorAll(".fa-tabs button").forEach((btn)=>{
  btn.onclick = ()=>{ if (btn.id === "nav-menu") { toggleMenu(); return; } var p = btn.dataset.page; if (p) navigate(p); };
});
if ($("faMoreMenu")) { $("faMoreMenu").querySelectorAll("button[data-page]").forEach((btn)=>{ btn.onclick = ()=>{ navigate(btn.dataset.page); }; }); }
</script>
</body>
</html>
