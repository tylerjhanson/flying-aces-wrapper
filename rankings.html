
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="robots" content="noindex, nofollow">
<title>Flying Aces Rankings</title>


<style>
:root{ --fa-header-offset: 0px; }

/* Header container */
.fa-header{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #f7f8fa;
  border-bottom: none;
  padding: 0 !important;
  box-sizing: border-box;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* ✅ Help block pinch/zoom gestures inside iframe (browser-dependent) */
html, body { touch-action: pan-x pan-y; }

/* ============ TOP TABS (4) ============ */
.fa-header .fa-tabs{
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px !important;
  padding: 8px 0 !important;
  margin: 0 !important;
  border: none !important;
  background: transparent !important;
  border-radius: 0 !important;
}

/* Shared button base for top tabs + submenu buttons */
.fa-header .fa-tabs button,
.fa-header .fa-submenu button{
  -webkit-appearance:none !important;
  appearance:none !important;

  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  width:100% !important;
  box-sizing:border-box !important;

  font-family:"Segoe UI", Roboto, Arial, sans-serif !important;
  font-weight:900 !important;
  font-size: clamp(12px, 3.6vw, 16px) !important;
  letter-spacing: .2px !important;
  line-height: 1 !important;

  height: 40px !important;
  min-height: 40px !important;
  padding: 0 6px !important;

  border-radius: 8px !important;
  border: 0 !important;
  outline: none !important;

  background: linear-gradient(180deg, #f9f9f9 0%, #ededed 100%) !important;
  box-shadow: 0 1px 4px rgba(0,0,0,.10) !important;

  color: #222 !important;
  cursor: pointer !important;

  transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease, filter .12s ease !important;

  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;

  -webkit-tap-highlight-color: transparent !important;
  user-select: none !important;
}

.fa-header .fa-tabs button:not(.active):hover,
.fa-header .fa-submenu button:not(.sub-active):hover{
  background: linear-gradient(180deg, #f1f1f1 0%, #e3e7f0 100%) !important;
}

/* Active tab */
.fa-header .fa-tabs button.active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

/* Tap flash */
.fa-header .fa-tabs button.fa-press,
.fa-header .fa-submenu button.fa-press{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color: #ffffff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.06);
}

.fa-header .fa-tabs button:active,
.fa-header .fa-submenu button:active{
  transform: scale(0.99);
}

/* ======= Hamburger button + logo ======= */
#nav-menu{
  padding: 0 10px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 10px !important;
}

#nav-menu .menu-logo{
  height: 18px;
  width: auto;
  display: block;
}

#nav-menu .hamburger-icon{
  width: 24px;
  height: 24px;
  flex: 0 0 auto;
}
#nav-menu .hamburger-icon{
  width: 24px;
  height: 24px;
  flex: 0 0 auto;
}

/* ============ DROPDOWN MENU (hamburger) ============ */
.fa-submenu-wrap{ position: relative; }

.fa-submenu{
  position: absolute;
  top: 100%;
  left: 0;
  padding: 8px 0 0;
  z-index: 1001;

  opacity: 0;
  transform: translateY(-6px);
  visibility: hidden;
  pointer-events: none;
  transition: opacity 140ms ease, transform 140ms ease, visibility 0s linear 140ms;
}
.fa-submenu.show{
  opacity: 1;
  transform: translateY(0);
  visibility: visible;
  pointer-events: auto;
  transition: opacity 140ms ease, transform 140ms ease;
}

.fa-submenu .inner{
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 12px 26px rgba(0,0,0,.16);
  border-radius: 14px;
  overflow: hidden;
  padding: 8px;

  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;

  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

/* Slightly taller menu rows feels more “iOS” without changing your top tabs */
.fa-header .fa-submenu button{
  height: 42px !important;
  min-height: 42px !important;
  font-size: 13px !important;
  border-radius: 12px !important;
}

.fa-header .fa-submenu button.sub-active{
  background: linear-gradient(135deg,#ff3b3b 0%, #e40000 100%) !important;
  color:#fff !important;
  box-shadow: 0 1px 6px rgba(228,0,0,.22) !important;
  filter: brightness(1.04);
}

@media (max-width: 420px){
  .fa-header .fa-tabs{ padding: 6px 0 !important; }
  .fa-header .fa-tabs button{
    height: 36px !important;
    min-height: 36px !important;
    font-size: 13px !important;
    padding: 0 6px !important;
  }
  .fa-header .fa-submenu button{
    height: 40px !important;
    min-height: 40px !important;
    font-size: 12.5px !important;
  }
  #nav-menu .hamburger-icon{
    width: 22px;
    height: 22px;
  }
}
@media (max-width: 420px){
  #nav-menu .menu-logo{ height: 16px; }
  #nav-menu .hamburger-icon{ width: 22px; height: 22px; }
}
/* =========================================================
   Pull-to-refresh toast (spinner-only pill)
   ========================================================= */
#fa-ptr{
  position: fixed;
  left: 50%;
  top: calc(env(safe-area-inset-top) + 10px);
  transform: translate(-50%, -14px);
  opacity: 0;
  z-index: 99999;
  pointer-events: none;

  display: inline-flex;
  align-items: center;
  justify-content: center;

  padding: 10px 12px;
  border-radius: 999px;

  background: rgba(255,255,255,.92);
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 18px rgba(0,0,0,.12);

  transition: opacity 140ms ease, transform 140ms ease;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
#fa-ptr.show{ opacity: 1; transform: translate(-50%, 0); }
#fa-ptr .spin{
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,.18);
  border-top-color: rgba(0,0,0,.55);
  animation: faSpin 800ms linear infinite;
}
@keyframes faSpin { to { transform: rotate(360deg); } }
</style>
<style>
:root{
  --btn-angle: 135deg;

  --red1:#ff3b3b;
  --red2:#e40000;

  --blue1:#3a86ff;
  --blue2:#0d6efd;

  /* NEW grey (matches “Singles” style vibe) */
  --gray1:#8a8f98;
  --gray2:#5f6670;
}

html, body {
    -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: #f7f8fa;
  margin: 0;
  padding: 4px;
  color: #222;
  overflow-x: hidden;
  font-size: 11px !important;
}

.container { width: 100%; margin: 0 auto; }

.top-panel{
  background:#fff !important;
  border-radius:18px !important;
  box-shadow:0 10px 30px rgba(0,0,0,.08) !important;
  padding:14px !important;
  margin:12px 0 8px !important;
  overflow:visible !important;
}

.aces-header { display: none !important; }
.control-content { padding: 6px 0 !important; }

.input-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px !important;
}

.input-group label{
  display:flex;
  align-items:center;
  justify-content:center;
  height: 24px !important;
  font-size: 0.95em !important;
  font-weight: 900 !important;
  border-radius: 8px;
  margin-bottom: 4px !important;
}

select{
  width: 100%;
  height: 28px !important;
  line-height: 28px !important;
  box-sizing: border-box;

  font-size: 16px !important;
  font-weight: 900 !important;
  color: #333 !important;
  -webkit-text-fill-color: #333 !important;

  text-align: center !important;
  text-align-last: center;

  border: 1.5px solid #d9d9d9 !important;
  border-radius: 8px !important;
  background-color: #fff !important;

  background-image: url("data:image/svg+xml;utf8,\
    <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'>\
      <path fill='%23666' d='M7 10l5 5 5-5z'/>\
    </svg>");
  background-repeat: no-repeat;
  background-position: right 8px center;
  background-size: 16px 16px;

  -webkit-appearance: none;
  appearance: none;

  padding: 0 28px 0 28px !important; /* ✅ symmetric */
}
select option{ text-align:center; }

.input-group:nth-child(1) label,
.input-group:nth-child(2) label,
.input-group:nth-child(3) label,
.input-group:nth-child(4) label {
  background: linear-gradient(var(--btn-angle),#000 0%, #000 100%) !important;
  color: #fff !important;
}
.color-bar { display:none !important; }

#total-warning {
  grid-column: 1 / -1;
  font-size: 0.95em !important;
  padding: 8px 0 !important;
  color: #dc3545;
  font-weight: bold;
  display: none;
  text-align: center;
}

.table-panel {
  background: #fff;
  border-radius: 10px;
  border-top: none !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 1.05em !important;
}

.table-panel thead th{
  background: #f0f0f0 !important;
  cursor: pointer;
  user-select: none;
  padding: 4px 6px !important;
  line-height: 1.02 !important;
  font-weight: 600 !important;
  font-size: 0.85em !important;
  color: #333 !important;
  text-transform: none !important;
  border-bottom: 1px solid #eee !important;
  vertical-align: top !important;
}
th::after, th.sort-desc::after, th.sort-asc::after { content: none !important; }

td {
  padding: 3.25px 2px !important;
  text-align: center;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  font-size: 1.05em !important;
}
#table-body tr:nth-child(even) td { background: rgba(0,0,0,0.03) !important; }

th:nth-child(1), td:nth-child(1) { width: 8% !important; }
th:nth-child(2), td:nth-child(2) {
  width: 27% !important;
  text-align: left !important;
  padding-left: 5px !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}
th:nth-child(7), td:nth-child(7) { width: 10% !important; }

#table-body td.rank-cell { position: relative; padding-left: 12px !important; }
#table-body td.rank-cell::before{
  content: "";
  position: absolute;
  left: 2px;
  top: 4px;
  bottom: 4px;
  width: 3px;
  border-radius: 3px;
  background: #d1d5db;
}
#table-body tr.q-top    td.rank-cell::before { background: #28a745; }
#table-body tr.q-high   td.rank-cell::before { background: #0d6efd; }
#table-body tr.q-mid    td.rank-cell::before { background: #f0ad00; }
#table-body tr.q-bottom td.rank-cell::before { background: #dc3545; }

.player-name { font-weight: 400 !important; font-size: 1.10em !important; }
.score-cell  { font-weight: 900; color: #000; }

.chart-panel { display: none !important; }

/* ===== Bottom controls (compact) ===== */
.bottom-controls{
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
}
.bottom-controls button{
  border: none;
  border-radius: 10px;
  padding: 16px 6px;
  font-size: 1.10em;
  font-weight: 900;
  cursor: pointer;
  color: #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,.10);
  transition: transform .08s ease, filter .15s ease, opacity .15s ease, box-shadow .15s ease;
  -webkit-tap-highlight-color: transparent;
}
.bottom-controls button:hover{
  box-shadow: 0 1px 6px rgba(0,0,0,.18);
  filter: brightness(1.06);
}
.bottom-controls button:active{
  transform: scale(0.99);
  filter: brightness(1.03);
}
.bottom-controls button:disabled{
  opacity: .6;
  cursor: not-allowed;
  filter: none;
}
#rerankBtn{ background: linear-gradient(var(--btn-angle), var(--red1) 0%, var(--red2) 100%) !important; }
#resetMenuBtn{ background: linear-gradient(var(--btn-angle), var(--blue1) 0%, var(--blue2) 100%) !important; }
/* legacy ids (safe to keep) */
#applyBtn{ background: linear-gradient(var(--btn-angle), var(--red1) 0%, var(--red2) 100%); }
#resetBtn{ background: linear-gradient(var(--btn-angle), var(--gray1) 0%, var(--gray2) 100%); }

/* ✅ Loading overlay */
#loadingOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease, visibility .2s ease;
}
#loadingOverlay.active{
  visibility: visible;
  opacity: 1;
  pointer-events: auto;
}
.loadingPulse{
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #0d6efd;
  animation: pulse 1.2s ease-in-out infinite;
}
@keyframes pulse{
  0%{transform:scale(1);opacity:.9}
  50%{transform:scale(1.08);opacity:1}
  100%{transform:scale(1);opacity:.9}
}

/* ===== Big dialog select fix (mobile) ===== */
#overlay_big_dialog select{
  font-size: 16px !important;
  line-height: 1.15 !important;
  height: 54px !important;
  padding: 10px 44px 10px 16px !important;
  text-align: center !important;
  text-align-last: center;
}
@media (max-width: 420px){
  #overlay_big_dialog select{ font-size: 1.0em !important; }
}

@media (max-width: 430px){
  body{ font-size: 11px !important; }
  .input-grid{ gap: 5px !important; }
  label{ height: 32px !important; }
  select{ height: 32px !important; }
}



/* =========================================================
   Consistent page header (matches red “active” pages)
   ========================================================= */
.panel{
  background:#fff;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  padding:14px;
  margin:12px 0;
}
.panel-titlebar{
  display:flex;
  align-items:center;
  justify-content:center;

  /* span edge-to-edge inside .panel (which has padding:14px) */
  margin:-14px -14px 10px;

  /* ✅ 32px tall */
  height:32px;
  padding:0 14px;
  box-sizing:border-box;

  text-transform:uppercase;
  font-weight:950;
  font-size:14px;
  letter-spacing:.02em;
  user-select:none;

  color:#fff;
  background: linear-gradient(var(--btn-angle), var(--red1) 0%, var(--red2) 100%);
  border-radius:18px 18px 0 0;
}

</style>
</head>

<body>
<script>window.EXEC_BASE = '<?!= execBase ?>';</script>
<div class="fa-header fa-submenu-wrap">
  <nav class="fa-tabs">
    <button id="nav-scoring"  type="button" data-page="scoring">SCORING</button>
    <button id="nav-rosters"  type="button" data-page="rosters">ROSTERS</button>
    <button id="nav-matchups" type="button" data-page="matchups">MATCHUPS</button>

    <!-- Hamburger -->
<button id="nav-menu" type="button" data-key="menu" aria-expanded="false" aria-label="More">
  <img
    class="menu-logo"
    src="https://lufberydiscgolf.com/wp-content/uploads/2025/05/lufberyflyingace_logo-1.png?w=64&h=32"
    alt=""
    aria-hidden="true"
    loading="eager"
    decoding="async"
  />
  <svg class="hamburger-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
  </svg>
</button>

  </nav>

  <!-- Dropdown (anchored under hamburger) -->
  <div class="fa-submenu" id="faMoreMenu" aria-hidden="true">
    <div class="inner">
  <button data-page="rankings">RANKINGS</button>
  <button data-page="stats">STATS</button>
  <button data-page="elo">ELO</button>
  <button data-page="standings">STANDINGS</button>
  <button data-page="admin">ADMIN</button>
</div>
  </div>
</div>

<script>
/* ===========================
   0) Disable pinch/zoom inside iframe (iOS Safari fallback)
   =========================== */
(function(){
  ['gesturestart','gesturechange','gestureend'].forEach(function(evt){
    document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive:false });
  });

  var lastTouchEnd = 0;

  function _faIsIOS_(){
    try{
      var ua = navigator.userAgent || "";
      var plat = navigator.platform || "";
      var isIPhoneIPadIPod = /iPad|iPhone|iPod/.test(ua);
      var isIPadOS = (plat === "MacIntel" && (navigator.maxTouchPoints || 0) > 1);
      return isIPhoneIPadIPod || isIPadOS;
    }catch(_){ return false; }
  }
  function _faIsInteractive_(t){
    try{
      return !!(t && t.closest && t.closest("button,a,input,select,textarea,label,[role='button'],[contenteditable='true']"));
    }catch(_){ return false; }
  }

  document.addEventListener('touchend', function(e){
    if (!_faIsIOS_()) return;
    if (_faIsInteractive_(e.target)) return;

    var now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, { passive:false });
})();

/* ===========================
   1) Header nav + menu + active state
   =========================== */
(function(){
  function qs() {
    try { return new URLSearchParams(window.location.search || ""); }
    catch (e) { return new URLSearchParams(""); }
  }

  function currentPage(){
    var p = (qs().get("p") || qs().get("page") || "").toLowerCase();

    // Support hash routing (GitHub wrapper uses #scoring, #matchups, etc.)
    if (!p){
      var h = (window.location.hash || "").replace(/^#/, "").toLowerCase();
      h = h.replace(/^\/+/, "");
      if (h.indexOf("?") !== -1) h = h.split("?")[0];
      if (h.indexOf("&") !== -1) h = h.split("&")[0];
      p = h;
    }

    if (!p) return "";
    if (p === "doubles") p = "rosters";
    if (p === "scores") p = "scoring";
    if (p === "players") p = "admin";
    return p;
  }

  function isEmbedded(){
    try { if (window.top !== window) return true; } catch(e){ return true; }
    var embed = (qs().get("embed") || "").toLowerCase();
    return (embed === "1" || embed === "true" || embed === "yes");
  }

  // Pages that live under the hamburger menu
  const menuPages = ['rankings','stats','standings','elo','admin','players'];

  function setActiveByPage(page){
    page = String(page||"").toLowerCase();

    // top tabs
    document.querySelectorAll(".fa-tabs button").forEach(function(b){
      var key = b.dataset.key || b.dataset.page || "";
      var active = false;
      if (key === "menu") active = (menuPages.indexOf(page) !== -1);
      else active = (b.dataset.page === page);
      b.classList.toggle("active", !!active);
    });

    // dropdown buttons
    var menu = document.getElementById("faMoreMenu");
    if (menu){
      menu.querySelectorAll("button[data-page]").forEach(function(btn){
        btn.classList.toggle("sub-active", (btn.dataset.page === page));
      });
    }
  }

  function detectActive(){
    try{
      var p = currentPage();
      if (menuPages.indexOf(p) !== -1 || ["scoring","rosters","matchups"].indexOf(p) !== -1){
        setActiveByPage(p);
        return;
      }
      
      // STATS title marker (helps when Stats page also contains roster/link sections)
      var titleBar = document.querySelector(".pageTitlePanel .panel-titlebar, .panel.pageTitlePanel .panel-titlebar, .panel-titlebar");
      if (titleBar && /stats/i.test((titleBar.textContent || "").trim())){
        setActiveByPage("stats");
        return;
      }

// ELO markers
      if (
        document.getElementById("kBase") ||
        document.getElementById("overallBody") ||
        document.getElementById("pairsBody") ||
        /(^|\s)elo(\s|$)/i.test(document.title || "")
      ){
        setActiveByPage("elo");
        return;
      }

      // DOM heuristics
      if (document.getElementById("singlesBody") || document.getElementById("recentCards")) { setActiveByPage("stats"); return; }
      if (document.getElementById("table-body")) { setActiveByPage("rankings"); return; }
      if (document.getElementById("b1") || document.getElementById("b2") || document.getElementById("b9")) { setActiveByPage("scoring"); return; }
      if (document.getElementById("panel-CURRENT")) { setActiveByPage("rosters"); return; }
      if (document.getElementById("playersTable") || document.getElementById("teamSelect")) { setActiveByPage("admin"); return; }
      if (document.getElementById("team1Table") || document.getElementById("team2Table")) { setActiveByPage("matchups"); return; }
      // Standings markers
      if (document.getElementById("matchResults") || document.getElementById("adjWrap") || document.getElementById("simMatchup")) { setActiveByPage("standings"); return; }

      // title fallback
      var t = (document.title || "").toLowerCase();
      if (t.indexOf("stat") !== -1) { setActiveByPage("stats"); return; }
      if (t.indexOf("ranking") !== -1) { setActiveByPage("rankings"); return; }
      if (t.indexOf("scor") !== -1) { setActiveByPage("scoring"); return; }
      if (t.indexOf("roster") !== -1 || t.indexOf("double") !== -1) { setActiveByPage("rosters"); return; }

      setActiveByPage("matchups");
    }catch(e){
      setActiveByPage("matchups");
    }
  }

  function extraQS(){
    var s = qs();
    var parts = [];
    parts.push("embed=1");
    var scale = s.get("scale");
    var v = s.get("v");
    if (scale) parts.push("scale=" + encodeURIComponent(scale));
    if (v) parts.push("v=" + encodeURIComponent(v));
    return parts.length ? ("&" + parts.join("&")) : "";
  }

  function buildHref(page){
    return "?p=" + encodeURIComponent(page) + extraQS();
  }

  function sendToWrapper(page){
    var msg = { type: "FA_NAV", page: page };
    var sent = false;
    try { window.top.postMessage(msg, "*"); sent = true; } catch(e){}
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(msg, "*");
        sent = true;
      }
    } catch(e){}
    return sent;
  }

  // ---- menu open/close ----
  var menuBtn  = document.getElementById("nav-menu");
  var menuEl   = document.getElementById("faMoreMenu");

  function setMenuAria(open){
    if (!menuBtn) return;
    menuBtn.setAttribute("aria-expanded", open ? "true" : "false");
  }

  function positionMenu(){
    if (!menuEl || !menuBtn) return;
    var wrap = document.querySelector(".fa-submenu-wrap");
    if (!wrap) return;

    var wrapRect = wrap.getBoundingClientRect();
    var btnRect  = menuBtn.getBoundingClientRect();

    // Wider than the button for a “real site” menu feel
    var width = Math.max(btnRect.width + 12, 200);
    width = Math.min(width, Math.floor(wrapRect.width - 8));

    // Right-align under the hamburger (more typical)
    var left = (btnRect.right - wrapRect.left) - width;

    // Clamp within wrap bounds
    var maxLeft = Math.max(0, wrapRect.width - width);
    left = Math.max(0, Math.min(left, maxLeft));

    menuEl.style.left = left + "px";
    menuEl.style.right = "auto";
    menuEl.style.width = width + "px";
  }

  function openMenu(){
    if (!menuEl) return;
    positionMenu();
    menuEl.classList.add("show");
    menuEl.setAttribute("aria-hidden","false");
    setMenuAria(true);
  }

  function closeMenu(){
    if (!menuEl) return;
    menuEl.classList.remove("show");
    menuEl.setAttribute("aria-hidden","true");
    setMenuAria(false);
  }

  function toggleMenu(){
    if (!menuEl) return;
    if (menuEl.classList.contains("show")) closeMenu();
    else openMenu();
  }

  function navigate(page){
    page = String(page||"").toLowerCase();
    if (!page) return;

    closeMenu();

    // Active immediately so tap feels responsive
    setActiveByPage(page);

    var embedded = isEmbedded();
    if (embedded){
      var ok = sendToWrapper(page);
      if (!ok) window.location.href = buildHref(page);
    }else{
      window.location.href = buildHref(page);
    }
  }

  // Close on outside click
  document.addEventListener("click", function(e){
    if (!menuEl || !menuEl.classList.contains("show")) return;
    var t = e.target;
    if (t === menuBtn || (menuBtn && menuBtn.contains(t))) return;
    if (menuEl.contains(t)) return;
    closeMenu();
  }, true);

  // Keep menu anchored on resize/orientation changes
  window.addEventListener("resize", function(){
    if (menuEl && menuEl.classList.contains("show")) positionMenu();
  }, { passive:true });

  // ESC closes
  document.addEventListener("keydown", function(e){
    if (e.key === "Escape") closeMenu();
  });

  // Tap flash
  function flash(btn){
    if (!btn) return;
    btn.classList.add("fa-press");
    window.setTimeout(function(){ btn.classList.remove("fa-press"); }, 140);
  }
  function wireFlash(root){
    if (!root) return;
    root.querySelectorAll("button").forEach(function(btn){
      btn.addEventListener("touchstart", function(){ flash(btn); }, { passive:true });
      btn.addEventListener("mousedown",  function(){ flash(btn); }, { passive:true });
    });
  }
  wireFlash(document.querySelector(".fa-tabs"));
  wireFlash(menuEl);

  // Wire top tabs
  document.querySelectorAll(".fa-tabs button").forEach(function(btn){
    btn.addEventListener("click", function(){
      if (btn.id === "nav-menu"){ toggleMenu(); return; }
      var page = btn.dataset.page;
      if (page) navigate(page);
    });
  });

  // Wire dropdown
  if (menuEl){
    menuEl.querySelectorAll("button[data-page]").forEach(function(btn){
      btn.addEventListener("click", function(){
        navigate(btn.dataset.page);
      });
    });
  }

  // Expose helpers
  try { window.faNavigate = navigate; } catch(e){}
  try { window.navigate = navigate; } catch(e){}
  try { window.faSetActiveByPage = setActiveByPage; } catch(e){}
  try { window.faDetectActive = detectActive; } catch(e){}

  // Keep active tab in sync for hash-routed / SPA navigation
  window.addEventListener("hashchange", function(){ setTimeout(detectActive, 0); }, { passive:true });
  window.addEventListener("popstate",  function(){ setTimeout(detectActive, 0); }, { passive:true });
  try{
    ["pushState","replaceState"].forEach(function(fn){
      var orig = history[fn];
      if (!orig) return;
      history[fn] = function(){
        var r = orig.apply(this, arguments);
        setTimeout(detectActive, 0);
        return r;
      };
    });
  }catch(_){ }

  detectActive();
  setMenuAria(false);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(detectActive, 0); });
  } else {
    setTimeout(detectActive, 0);
  }
})();

/* ===========================
   2) Pull-to-refresh (unchanged)
   =========================== */
(function(){
  function isEmbedded(){
    try { return window.top !== window; } catch(e){ return true; }
  }

  function scrollTop(){
    var se = document.scrollingElement || document.documentElement || document.body;
    return se ? (se.scrollTop || 0) : 0;
  }

  function headerBottom(){
    var h = document.querySelector(".fa-header");
    if (!h) return 0;
    var r = h.getBoundingClientRect();
    return r ? (r.bottom || r.height || 0) : 0;
  }

  function isInteractiveTarget(el){
    if (!el) return false;
    return !!el.closest("button,a,input,select,textarea,label,[role='button'],[contenteditable='true'],[data-no-ptr]");
  }

  function _isVisible_(el){
    try{
      if (!el) return false;
      var cs = getComputedStyle(el);
      if (cs.display === "none" || cs.visibility === "hidden") return false;
      if (parseFloat(cs.opacity || "1") === 0) return false;
      var r = el.getBoundingClientRect();
      return !!(r && r.width > 0 && r.height > 0);
    }catch(_){ return false; }
  }

  function inModalOrOverlay(el){
    try{
      return !!(el && el.closest && el.closest(
        "[data-no-ptr],[aria-modal='true'],[role='dialog'],[role='alertdialog'],dialog,.modal,.dialog,.overlay"
      ));
    }catch(_){ return false; }
  }

  function isModalOpen(){
    try{
      if (document.body && document.body.classList && document.body.classList.contains("modal-open")) return true;

      // Any visible dialog/modal/overlay element that is positioned above content
      var nodes = document.querySelectorAll("[aria-modal='true'],dialog[open],[role='dialog'],[role='alertdialog'],.modal,.dialog,.overlay");
      for (var i=0; i<nodes.length; i++){
        var n = nodes[i];
        if (!n || (n.classList && n.classList.contains("fa-header"))) continue;
        if (!_isVisible_(n)) continue;
        var cs = getComputedStyle(n);
        if (cs.position === "fixed" || cs.position === "absolute") return true;
      }
    }catch(_){}
    return false;
  }

  var toast;

  function ensureToast(){
    if (toast) return true;
    if (!document.body) return false;
    toast = document.createElement("div");
    toast.id = "fa-ptr";
    toast.innerHTML = '<span class="spin"></span>';
    document.body.appendChild(toast);
    return true;
  }

  function showToast(){
    if (!ensureToast()) return;
    toast.classList.add("show");
  }

  function hideToast(){
    if (!toast) return;
    toast.classList.remove("show");
  }

  function postRefresh(nonce){
    var msg = { type: "FA_REFRESH", nonce: nonce };
    try { window.top.postMessage(msg, "*"); } catch(e){}
    try {
      if (window.parent && window.parent !== window) window.parent.postMessage(msg, "*");
    } catch(e){}
  }

  function hardReloadSelf(){
    try {
      var u = new URL(location.href);
      u.searchParams.set("r", String(Date.now()));
      u.searchParams.set("fresh", "1");
      location.replace(u.toString());
    } catch(e) {
      location.reload();
    }
  }

  function requestRefresh(){
    var nonce = Date.now();
    var didUnload = false;
    window.addEventListener("beforeunload", function(){ didUnload = true; }, { once:true });

    if (isEmbedded()) postRefresh(nonce);
    else hardReloadSelf();

    setTimeout(function(){
      if (!didUnload) hardReloadSelf();
    }, 350);
  }

  var startY = 0, startX = 0, lastDy = 0;
  var armed = false;

  // Make accidental refreshes harder, but still easy enough when intentional
  var THRESH = 120;   // was 90
  var SHOW_AT = 18;   // was 12
  var MAX_SLOP_X = 80;
  var VERTICAL_RATIO = 2.0;

  window.addEventListener("touchstart", function(e){
    if (!e.touches || e.touches.length !== 1) { armed = false; return; }

    // Only arm when the MAIN page is truly at the top
    if (scrollTop() > 0) { armed = false; return; }

    // Never arm while a modal/overlay is open (prevents modal-top bounce triggering refresh)
    if (isModalOpen() || inModalOrOverlay(e.target)) { armed = false; return; }

    // Never arm on buttons/inputs/explicit no-ptr zones
    if (isInteractiveTarget(e.target)) { armed = false; return; }

    var t = e.touches[0];
    startY = t.clientY;
    startX = t.clientX;
    lastDy = 0;

    // Allow pull-to-refresh starting anywhere below the sticky header
    armed = (startY >= (headerBottom() + 6));
  }, { passive:true });

  window.addEventListener("touchmove", function(e){
    if (!armed || !e.touches || e.touches.length !== 1) return;

    var t = e.touches[0];
    var dy = t.clientY - startY;
    var dx = t.clientX - startX;

    if (dy <= 0){
      lastDy = 0;
      hideToast();
      return;
    }

    var adx = Math.abs(dx);
    if (adx > MAX_SLOP_X || dy < adx * VERTICAL_RATIO){
      lastDy = 0;
      hideToast();
      return;
    }

    if (dy > SHOW_AT){
      lastDy = dy;
      showToast();
    }
  }, { passive:true });

  window.addEventListener("touchend", function(){
    if (!armed){ hideToast(); return; }

    if (lastDy >= THRESH){
      showToast();
      setTimeout(requestRefresh, 60);
    } else {
      hideToast();
    }

    armed = false;
    lastDy = 0;
  }, { passive:true });

  window.addEventListener("touchcancel", function(){
    armed = false;
    lastDy = 0;
    hideToast();
  }, { passive:true });
})();
</script>

<div class="container">
  <div class="top-panel">
    
    <div class="panel-titlebar">RANKINGS</div>
<div class="control-content">
      <div class="input-grid">

        <div class="input-group">
          <label>CAPTAIN</label>
          <select id="w-capt" onchange="calculateRankings()"></select>
        </div>

        <div class="input-group">
          <label>PDGA</label>
          <select id="w-pdga" onchange="calculateRankings()"></select>
        </div>

        <div class="input-group">
          <label>LEAGUE</label>
          <select id="w-league" onchange="calculateRankings()"></select>
        </div>

        <div class="input-group">
          <label>TC %</label>
          <select id="w-tc" onchange="calculateRankings()"></select>
        </div>

        <div id="total-warning">Weights must = 100%!</div>
      </div>
    </div>
  </div>

  <div class="table-panel">
    <table>
      <thead>
        <tr>
          <th onclick="sortTable('rank')">&nbsp;&nbsp;&nbsp;↑↓</th>
          <th onclick="sortTable('name')">PLAYER</th>
          <th onclick="sortTable('capt')">CAPTAIN</th>
          <th onclick="sortTable('pdga')">PDGA</th>
          <th onclick="sortTable('league')">LEAGUE</th>
          <th onclick="sortTable('tc')">TC</th>
          <th onclick="sortTable('total')">TOTAL</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="7" style="padding:14px; color:#777; font-weight:800;">Loading…</td></tr>
      </tbody>
    </table>
  </div>
  <!-- ✅ 2 buttons -->
  <div class="bottom-controls">
    <button id="rerankBtn" onclick="openRerankMenu()">RE-RANK</button>
    <button id="resetMenuBtn" onclick="openResetMenu()">RESET</button>
  </div>
</div>

<div id="loadingOverlay"><div class="loadingPulse"></div></div>

<script>const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxlyif58qdt0l90lSvHOm0TxlPffdfMqajwzhGDQlddsNNn82Bg37CGoMpjBKBuZoNK/exec";
window.google = { script: { run: new Proxy({}, { get: (t, prop) => createProxy(null, null)[prop] }) } };
function createProxy(s, f) {
  return new Proxy({}, {
    get: (t, prop) => {
      if (prop === 'withSuccessHandler') return (cb) => createProxy(cb, f);
      if (prop === 'withFailureHandler') return (cb) => createProxy(s, cb);
      return (...args) => fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: prop, args: args }) })
        .then(r => r.json()).then(d => { if(d.ok && s) s(d.result); }).catch(e => { if(f) f(e); });
    }
  });
}

/* ===== Big dialog helpers ===== */
/* ===== Rank tiers (single source of truth) =====
   Server-side rerank writes A/B/C/D into the Players sheet.
   Rankings page colors should match those same thresholds.
   Default here is a safe fallback; it is overwritten from Code.gs (getAcesRankTiers) when available.
*/
let RANK_TIERS = { A: 75, B: 40, C: 25 };

/** Map Rank letters (A/B/C/D) to the existing left-bar color classes. */
function rankTierToShade(rank){
  rank = String(rank||"").trim().toUpperCase();
  if (rank === "A") return "q-top";    // green
  if (rank === "B") return "q-high";   // blue
  if (rank === "C") return "q-mid";    // yellow
  if (rank === "D") return "q-bottom"; // red
  return "q-bottom";
}


function totalToTier(total){
  // Uses current thresholds in RANK_TIERS (values in 0..100).
  total = Number(total);
  if (!isFinite(total)) return "D";
  const A = (RANK_TIERS && isFinite(RANK_TIERS.A)) ? Number(RANK_TIERS.A) : 75;
  const B = (RANK_TIERS && isFinite(RANK_TIERS.B)) ? Number(RANK_TIERS.B) : 40;
  const C = (RANK_TIERS && isFinite(RANK_TIERS.C)) ? Number(RANK_TIERS.C) : 25;
  if (total >= A) return "A";
  if (total >= B) return "B";
  if (total >= C) return "C";
  return "D";
}

function _normalizeTiers_(t){
  if (!t || typeof t !== "object") return null;
  const A = Number(t.A), B = Number(t.B), C = Number(t.C);
  if (![A,B,C].every(Number.isFinite)) return null;
  if (!(A >= B && B >= C)) return null;
  return { A, B, C };
}

function fetchRankTiers_(){
  return new Promise((resolve) => {
    try{
      if (!google || !google.script || !google.script.run || typeof google.script.run.getAcesRankTiers !== "function"){
        return resolve(RANK_TIERS);
      }
      google.script.run
        .withSuccessHandler((t) => {
          const nt = _normalizeTiers_(t);
          if (nt) RANK_TIERS = nt;
          if (processedData && processedData.length) renderTable();
          resolve(RANK_TIERS);
        })
        .withFailureHandler(() => resolve(RANK_TIERS))
        .getAcesRankTiers();
    } catch (e){
      resolve(RANK_TIERS);
    }
  });
}

function openBigDialog(){
  const overlay = document.createElement("div");
  overlay.id = "overlay_big_dialog";
  // If the Cloudflare wrapper is handling scrolling (iframe is tall), a fixed overlay can appear off-screen.
  // We position the overlay relative to the wrapper scroll instead.
  const qs = new URLSearchParams(location.search||"");
  const embedded = qs.get("embed") === "1";
  const ps = (embedded && typeof window.__FA_PARENT_SCALE === "number" && window.__FA_PARENT_SCALE>0) ? window.__FA_PARENT_SCALE : 1;
  const py = (embedded && typeof window.__FA_PARENT_SCROLL_Y === "number") ? window.__FA_PARENT_SCROLL_Y : 0;
  const pvh = (embedded && typeof window.__FA_PARENT_VH === "number" && window.__FA_PARENT_VH>0) ? window.__FA_PARENT_VH : window.innerHeight;
  if (embedded) {
    overlay.style.position = "absolute";
    overlay.style.left = "0";
    overlay.style.right = "0";
    overlay.style.top = Math.max(0, Math.floor(py / ps)) + "px";
    overlay.style.height = Math.max(320, Math.floor(pvh / ps)) + "px";
  } else {
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
  }
  overlay.style.background = "rgba(0,0,0,0.6)";
  overlay.style.display = "flex"; overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center"; overlay.style.zIndex = "9999";
  overlay.style.backdropFilter = "blur(2px)";

  const box = document.createElement("div");
  box.style.width = "96vw"; box.style.maxWidth = "700px";
  // Keep the dialog box within the *visible* portion of the scaled view when embedded.
  if (embedded) {
    box.style.maxHeight = Math.max(240, Math.floor((pvh / ps) * 0.82)) + "px";
  } else {
    box.style.maxHeight = "80vh";
  }

  box.style.overflow = "auto"; box.style.borderRadius = "20px"; box.style.background = "#fff";
  box.style.padding = "28px"; box.style.boxShadow = "0 12px 40px rgba(0,0,0,0.35)";
  box.style.fontSize = "1.8em";
  box.style.touchAction = "manipulation";
  box.style.transform = "scale(0.98)";
  box.style.transition = "transform 120ms ease-out";
  requestAnimationFrame(()=>{box.style.transform="scale(1)"});

  const close = ()=> overlay.remove();
  overlay.addEventListener("click", e=>{ if(e.target===overlay) close(); }, {passive:true});
  document.addEventListener("keydown", function esc(e){
    if(e.key==="Escape"){ close(); document.removeEventListener("keydown", esc); }
  });

  box.setAttribute("role","dialog"); box.setAttribute("aria-modal","true");
  overlay.appendChild(box); document.body.appendChild(overlay);
  try { if (embedded) parent.postMessage({type:"FA_LOCK_SCROLL", lock:true}, "*"); } catch(e){}
  return { overlay, box, close };
}


function goToStats(){
  try{
    if (typeof navigate === "function") { navigate("stats"); return; }
  }catch(_){}
  // Fallback
  window.location.href = "?p=stats" + (location.search && location.search.indexOf("embed=1")>=0 ? "&embed=1" : "");
}


function makeBigDialogButton(label,bg,fg="white"){
  const b=document.createElement("button");
  b.textContent=label;
  b.style.display="block"; b.style.width="100%";
  b.style.padding="14px 14px";
  b.style.minHeight="62px";
  b.style.margin="8px 0";
  b.style.fontSize="1.0em";
  b.style.lineHeight="1.15";
  b.style.fontWeight="800";
  b.style.letterSpacing="0.3px";
  b.style.border="none";
  b.style.borderRadius="16px";
  b.style.background=bg;
  b.style.color=fg;
  b.style.cursor="pointer";
  b.style.webkitTapHighlightColor="transparent";
  b.onpointerdown=()=>b.style.transform="scale(0.985)";
  b.onpointerup  =()=>b.style.transform="";
  b.onpointercancel=()=>b.style.transform="";
  return b;
}

function showPopup(title, message, color="#0d6efd"){
  const {box, close}=openBigDialog();
  const h=document.createElement("h3");
  h.textContent=title||"Message";
  h.style.margin="0 0 12px 0";
  h.style.fontSize="1.1em";
  h.style.fontWeight="900";
  h.style.color=color;

  const p=document.createElement("div");
  p.innerHTML=message||"";
  p.style.margin="6px 0 18px";
  p.style.fontSize="0.9em";
  p.style.lineHeight="1.35";
  p.style.color="#111";

  const ok=makeBigDialogButton("OK", color);
  ok.onclick=close;

  box.appendChild(h); box.appendChild(p); box.appendChild(ok);
}

/* ✅ Loading overlay control */
function setLoading(on){
  const o = document.getElementById("loadingOverlay");
  if (!o) return;
  o.classList.toggle("active", !!on);

  ['rerankBtn','resetMenuBtn','applyBtn','resetBtn','w-capt','w-pdga','w-league','w-tc'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !!on;
  });
}

/* ===== Rankings logic ===== */
let rawData = [];
let processedData = [];
let sortDirection = -1;
let currentSortKey = 'total';

// Used to avoid auto-sync re-render "flashing" while the user is actively changing weights
let __rankingsLastInteractionMs = 0;

const CACHE_KEY = 'fa_rankings_pack_v2';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes
// Cross-device sync (Rankings)
let __rankingsV = String(localStorage.getItem('fa_rankings_v') || '');
let __rankingsAutoSyncTimer = null;
let __rankingsSyncBusy = false;


  // Weight presets (order matters: shown in RESET menu)
  const WEIGHT_PRESETS = [
    { label:'60/15/15/10', capt:60, pdga:15, league:15, tc:10 },
    { label:'40/25/25/10', capt:40, pdga:25, league:25, tc:10 },
    { label:'30/30/30/10', capt:30, pdga:30, league:30, tc:10 },
  ];

  // Default on first load (keeps your existing 40/25/25/10 behavior)
  const DEFAULT_WEIGHTS = WEIGHT_PRESETS[1];

// ✅ Robust init: don't rely on window.onload (Header include can overwrite it)
let __rankingsInited = false;
function initRankingsPage(){
  // Load tier thresholds from server so colors + rerank stay in sync.
  fetchRankTiers_();
  if (__rankingsInited) return;
  __rankingsInited = true;

  try { populateDropdownsFast(); } catch(e){ console.error(e); }

  try {
    const pack = loadCachedPack();
    if (pack && pack.v) {
      __rankingsV = String(__rankingsV || pack.v || '');
      try { localStorage.setItem('fa_rankings_v', __rankingsV); } catch(_){}
    }
    const cached = pack && Array.isArray(pack.rows) ? pack.rows : null;
    if (cached && cached.length) initData(cached, true);
  } catch(e){ console.error(e); }

  // Start auto-sync immediately (it will no-op until __rankingsV is known)
  try { startAutoSyncRankings(); } catch(e){ console.error(e); }

  // Always try to fetch live data last
  try { fetchLatestRankingsAndRefresh(); } catch(e){ console.error(e); }
}

// Run on whichever fires first (safe even if Header assigns window.onload)
document.addEventListener('DOMContentLoaded', initRankingsPage, { once:true });
window.addEventListener('load', initRankingsPage, { once:true });

function populateDropdownsFast() {
  const ids = ['w-capt','w-pdga','w-league','w-tc'];
  if (document.getElementById(ids[0]).options.length) return;

  let html = '';
  for (let i = 0; i <= 100; i += 5) html += `<option value="${i}">${i}%</option>`;
  ids.forEach(id => { document.getElementById(id).innerHTML = html; });
}

function loadCachedPack(){
  try {
    const s = sessionStorage.getItem(CACHE_KEY) || localStorage.getItem(CACHE_KEY);
    if (!s) return null;
    const obj = JSON.parse(s);

    // Legacy: old cache was stored as just an array of rows; treat as expired.
    if (Array.isArray(obj)) return null;

    if (!obj || !Array.isArray(obj.rows)) return null;

    const ts = Number(obj.ts || 0);
    if (ts && (Date.now() - ts) > CACHE_TTL_MS) return null;

    return {
      v: (obj.v != null) ? String(obj.v) : '',
      ts: ts || 0,
      rows: obj.rows
    };
  } catch(e){ return null; }
}

function saveCachedPack(v, rows){
  try{
    const pack = { v: String(v || ''), ts: Date.now(), rows: rows };
    try { sessionStorage.setItem(CACHE_KEY, JSON.stringify(pack)); } catch(e){}
    try { localStorage.setItem(CACHE_KEY, JSON.stringify(pack)); } catch(e){}
  } catch(e){}
}

// Convenience wrappers used by the rest of the page
function loadCachedRaw(){
  const pack = loadCachedPack();
  return pack ? pack.rows : null;
}
function saveCachedRaw(rows){
  const v = __rankingsV || String(localStorage.getItem('fa_rankings_v') || '');
  saveCachedPack(v, rows);
}

function getStoredWeight(key, fallback){
  const v = parseFloat(localStorage.getItem(key));
  return Number.isFinite(v) ? v : fallback;
}

function fetchLatestRankingsAndRefresh(done){
  if (typeof google === 'undefined') { if (done) done(); return; }

  google.script.run
    .withSuccessHandler(function(payload){
      // Backwards compatible: payload may be rows array (older server)
      var rows = (payload && payload.rows) ? payload.rows : payload;
      if (!Array.isArray(rows)) { if (done) done(); return; }

      // Track server version (used for cross-device sync)
      try{
        if (payload && payload.v != null) {
          __rankingsV = String(payload.v);
          localStorage.setItem('fa_rankings_v', __rankingsV);
        }
      }catch(_){}

      // Keep tier colors in sync (optional)
      try{
        var t = (payload && payload.tiers) ? _normalizeTiers_(payload.tiers) : null;
        if (t) RANK_TIERS = t;
      }catch(_){}

      // accept 6 cols (A:F)
      const normalized = rows.map(r => [r[0], r[1], r[2], r[3], r[4], r[5]]);

      // Save a versioned+timestamped cache so we don't show very old data on a later visit,
      // and so updates always overwrite reliably.
      saveCachedPack(__rankingsV, normalized);

      initData(normalized, false);

      // start polling after first live fetch
      startAutoSyncRankings();

      if (done) done();
    })
    .withFailureHandler(function(err){
      const msg = (err && err.message) ? err.message : String(err || "Unknown error");
      showPopup("Error", msg, "#dc3545");
      if (done) done();
    })
    .getRankingsPayload();
}


function startAutoSyncRankings(){
  if (__rankingsAutoSyncTimer) return;
  __rankingsAutoSyncTimer = setInterval(() => {
    if (__rankingsSyncBusy) return;
    if (!__rankingsV) return;

    // Don't disrupt open dialogs / active loading
    try{
      if (document.getElementById('overlay_big_dialog')) return;
      const lo = document.getElementById('loadingOverlay');
      if (lo && lo.style && lo.style.display && lo.style.display !== 'none') return;
    }catch(_){}

    __rankingsSyncBusy = true;
    google.script.run
      .withSuccessHandler((payload) => {
        __rankingsSyncBusy = false;
        if (!payload) return;

        const rows = payload.rows || payload;
        if (!Array.isArray(rows)) return;

        try{
          if (payload.v != null) {
            __rankingsV = String(payload.v);
            localStorage.setItem('fa_rankings_v', __rankingsV);
          }
        }catch(_){}

        try{
          const t = payload.tiers ? _normalizeTiers_(payload.tiers) : null;
          if (t) RANK_TIERS = t;
        }catch(_){}

        const normalized = rows.map(r => [r[0], r[1], r[2], r[3], r[4], r[5]]);
        saveCachedPack(__rankingsV, normalized);

        // Avoid UI "flashes" if data arrives while the user is actively changing weights
        if (Date.now() - (__rankingsLastInteractionMs || 0) < 1500) return;
        initData(normalized, false);
      })
      .withFailureHandler((err) => {
        __rankingsSyncBusy = false;
        console.warn("Rankings auto-sync failed", err);
      })
      .getRankingsDataIfNewer(__rankingsV);
  }, 8000);
}


function initData(data, fromCache) {
  // Women (AF/BF/CF ranks) are intentionally excluded from the Rankings table + rerank math.
  rawData = data
    .filter(r => {
      const baseRank = String(r[5] || "").trim().toUpperCase();
      return !/^(A|B|C)\-?F$/i.test(baseRank);
    })
    .map(r => ({
      name: r[0],
      tier: String(r[5] || "").trim().toUpperCase(),
      pdga: parseFloat(r[1]) || 0,
      league: parseFloat(r[2]) || 0,
      capt: parseFloat(r[3]) || 0,
      tc: parseFloat(r[4]) || 0
    }));

  const wC = getStoredWeight('w-capt', DEFAULT_WEIGHTS.capt);
  const wP = getStoredWeight('w-pdga', DEFAULT_WEIGHTS.pdga);
  const wL = getStoredWeight('w-league', DEFAULT_WEIGHTS.league);
  const wT = getStoredWeight('w-tc', DEFAULT_WEIGHTS.tc);

  document.getElementById('w-capt').value = wC;
  document.getElementById('w-pdga').value = wP;
  document.getElementById('w-league').value = wL;
  document.getElementById('w-tc').value = wT;

  if (!fromCache) { currentSortKey = 'total'; sortDirection = -1; }
  calculateRankings();
}

/* ===== Mean-preserving TOTAL (matches Rerank.gs) ===== */
function _faErf_(x){
  const sign = (x >= 0) ? 1 : -1;
  x = Math.abs(x);

  const a1 = 0.254829592;
  const a2 = -0.284496736;
  const a3 = 1.421413741;
  const a4 = -1.453152027;
  const a5 = 1.061405429;
  const p  = 0.3275911;

  const t = 1.0 / (1.0 + p * x);
  const y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-x*x);

  return sign * y;
}
function _faNormCdf_(z){
  return 0.5 * (1 + _faErf_(z / Math.sqrt(2)));
}
function _faMean_(arr){
  const n = arr.length;
  if (!n) return 0;
  let s = 0;
  for (let i=0;i<n;i++) s += arr[i];
  return s / n;
}
function _faStdevP_(arr, mu){
  const n = arr.length;
  if (!n) return 0;
  let ss = 0;
  for (let i=0;i<n;i++){
    const d = arr[i] - mu;
    ss += d*d;
  }
  return Math.sqrt(ss / n);
}


function calculateRankings() {
  __rankingsLastInteractionMs = Date.now();
  const vC = parseFloat(document.getElementById('w-capt').value) || 0;
  const vP = parseFloat(document.getElementById('w-pdga').value) || 0;
  const vL = parseFloat(document.getElementById('w-league').value) || 0;
  const vT = parseFloat(document.getElementById('w-tc').value) || 0;

  localStorage.setItem('w-capt', vC);
  localStorage.setItem('w-pdga', vP);
  localStorage.setItem('w-league', vL);
  localStorage.setItem('w-tc', vT);

  document.getElementById('total-warning').style.display =
    ((vC + vP + vL + vT) !== 100) ? 'block' : 'none';

  // weights as 0..1
  const wC = vC / 100;
  const wP = vP / 100;
  const wL = vL / 100;
  const wT = vT / 100;

  // Build arrays for means / stdevs (population), using tc in 0..1
  const pdgas = new Array(rawData.length);
  const leagues = new Array(rawData.length);
  const capts = new Array(rawData.length);
  const tcs = new Array(rawData.length);

  for (let i=0; i<rawData.length; i++){
    const p = rawData[i];
    pdgas[i] = Number(p.pdga) || 0;
    leagues[i] = Number(p.league) || 0;
    capts[i] = Number(p.capt) || 0;

    const tcRaw = Number(p.tc) || 0;
    tcs[i] = (tcRaw > 1) ? (tcRaw / 100) : tcRaw; // 75 => 0.75
  }

  const muPdga = _faMean_(pdgas),     sdPdga = _faStdevP_(pdgas, muPdga);
  const muLeague = _faMean_(leagues), sdLeague = _faStdevP_(leagues, muLeague);
  const muCapt = _faMean_(capts),     sdCapt = _faStdevP_(capts, muCapt);
  const muTc = _faMean_(tcs),         sdTc = _faStdevP_(tcs, muTc);

  const z = (x, mu, sd) => (sd > 0 ? (x - mu) / sd : 0);

  // Composite s = weighted z-scores (mean-preserving):
  // PDGA, TC higher better ( +z )
  // League, Captain lower better ( -z )
  const sVals = new Array(rawData.length);
  processedData = new Array(rawData.length);

  for (let i=0; i<rawData.length; i++){
    const p = rawData[i];

    const pdga = pdgas[i];
    const league = leagues[i];
    const capt = capts[i];
    const tc01 = tcs[i];

    const zPdga = z(pdga, muPdga, sdPdga);
    const zLeague = z(league, muLeague, sdLeague);
    const zCapt = z(capt, muCapt, sdCapt);
    const zTc = z(tc01, muTc, sdTc);

    const s = (-zCapt) * wC + (-zLeague) * wL + (zPdga) * wP + (zTc) * wT;
    sVals[i] = s;

    processedData[i] = {
      ...p,
      _tc01: tc01,
      _s: s
    };
  }

  const muS = _faMean_(sVals);
  const sdS = _faStdevP_(sVals, muS);

  for (let i=0; i<processedData.length; i++){
    const p = processedData[i];
    const scoreZ = (sdS > 0) ? ((p._s - muS) / sdS) : 0;

    // Percentile-like TOTAL in 0..100 (NOT forced so top=100)
    let total = _faNormCdf_(scoreZ) * 100;
    if (total < 0) total = 0;
    if (total > 100) total = 100;

    p.total = Math.round(total);
    p.previewTier = totalToTier(p.total);
    p._scoreZ = scoreZ;
  }

  processedData.sort((a,b)=> (b.total - a.total) || a.name.localeCompare(b.name));
  for (let i=0; i<processedData.length; i++) processedData[i].rank = i + 1;

  if (currentSortKey && currentSortKey !== 'total') sortTable(currentSortKey, true);
  else renderTable();
}

const DEFAULT_SORT_DIR = { rank:1, name:1, capt:1, league:1, pdga:-1, tc:-1, total:-1 };

function sortTable(key, silent){
  if (!silent) {
    if (currentSortKey === key) sortDirection *= -1;
    else { currentSortKey = key; sortDirection = DEFAULT_SORT_DIR[key] ?? -1; }
  }

  processedData.sort((a, b) => {
    let vA = a[key], vB = b[key];
    if (vA === vB) return (a.rank - b.rank);

    if (key === 'name') {
      return (sortDirection === 1)
        ? String(vA).localeCompare(String(vB))
        : String(vB).localeCompare(String(vA));
    }

    vA = Number(vA); vB = Number(vB);
    const aNaN = Number.isNaN(vA), bNaN = Number.isNaN(vB);
    if (aNaN && bNaN) return (a.rank - b.rank);
    if (aNaN) return 1;
    if (bNaN) return -1;

    return (sortDirection === 1) ? (vA - vB) : (vB - vA);
  });

  renderTable();
}

function renderTable(){
  let html = '';
  for (let i=0; i<processedData.length; i++){
    const p = processedData[i];
    const shade = rankTierToShade(p.previewTier || p.tier);
    const tcPct = (p.tc <= 1 ? p.tc * 100 : p.tc);

    html += `
      <tr class="${shade}">
        <td class="rank-cell">${p.rank}</td>
        <td class="player-name">${p.name}</td>
        <td>${p.capt}</td>
        <td>${(Number(p.pdga) > 0 ? p.pdga : '—')}</td>
        <td>${p.league}</td>
        <td>${tcPct.toFixed(0)}%</td>
        <td class="score-cell">${p.total}</td>
      </tr>`;
  }
  document.getElementById('table-body').innerHTML = html;
}

/* ===== Menus ===== */
function getWeights(){
  const vC = parseFloat(document.getElementById('w-capt').value) || 0;
  const vP = parseFloat(document.getElementById('w-pdga').value) || 0;
  const vL = parseFloat(document.getElementById('w-league').value) || 0;
  const vT = parseFloat(document.getElementById('w-tc').value) || 0;
  return { capt:vC, pdga:vP, league:vL, tc:vT, sum:(vC+vP+vL+vT) };
}


function openRerankMenu(){
  const { box, close } = openBigDialog();

  const apply = makeBigDialogButton(
    "CONFIRM RE-RANK",
    "linear-gradient(var(--btn-angle), var(--red1) 0%, var(--red2) 100%)"
  );

  const cancel = makeBigDialogButton(
    "CANCEL",
    "linear-gradient(var(--btn-angle), #eef1f5 0%, #dfe5ec 100%)",
    "#222"
  );

  apply.onclick  = () => { close(); runApply(); };
  cancel.onclick = () => { close(); };

  box.appendChild(apply);
  box.appendChild(cancel);
}

/* RESET menu: reset actions + weight presets */
function openResetMenu(){
  const { box, close } = openBigDialog();

  const resetDefaults = makeBigDialogButton(
    "RESET TO DEFAULT PDGA/RANKS",
    "linear-gradient(var(--btn-angle), var(--blue1) 0%, var(--blue2) 100%)"
  );

  // Weight presets (requested order)
  const w60151510 = makeBigDialogButton(
    "SET WEIGHTS (60/15/15/10)",
    "linear-gradient(var(--btn-angle), var(--gray1) 0%, var(--gray2) 100%)"
  );

  const w40252510 = makeBigDialogButton(
    "SET WEIGHTS (40/25/25/10)",
    "linear-gradient(var(--btn-angle), var(--gray1) 0%, var(--gray2) 100%)"
  );

  const w30303010 = makeBigDialogButton(
    "SET WEIGHTS (30/30/30/10)",
    "linear-gradient(var(--btn-angle), var(--gray1) 0%, var(--gray2) 100%)"
  );

  const cancel = makeBigDialogButton(
    "CANCEL",
    "linear-gradient(var(--btn-angle), #eef1f5 0%, #dfe5ec 100%)",
    "#222"
  );

  resetDefaults.onclick = () => { close(); runResetDefaults(); };
  w60151510.onclick     = () => { close(); setWeightsPreset(WEIGHT_PRESETS[0]); };
  w40252510.onclick     = () => { close(); setWeightsPreset(WEIGHT_PRESETS[1]); };
  w30303010.onclick     = () => { close(); setWeightsPreset(WEIGHT_PRESETS[2]); };
  cancel.onclick        = () => { close(); };

  box.appendChild(resetDefaults);
  box.appendChild(w60151510);
  box.appendChild(w40252510);
  box.appendChild(w30303010);
  box.appendChild(cancel);
}

// Backwards compatibility (older buttons / calls)
function openApplyMenu(){ openRerankMenu(); }


function runApply(){
  const w = getWeights();
  if (w.sum !== 100){
    showPopup("Weights", "Weights must equal <strong>100%</strong> before applying.", "#dc3545");
    return;
  }
  setLoading(true);

  google.script.run
    .withSuccessHandler(()=>{
      fetchLatestRankingsAndRefresh(()=>{
        setLoading(false);
        showPopup("Success", "Matchups Rank/Ratings Updated", "#28a745");
      });
    })
    .withFailureHandler((err)=>{
      setLoading(false);
      const msg = (err && err.message) ? err.message : String(err || "Unknown error");
      showPopup("Error", msg, "#dc3545");
    })
    .applyAcesRankingsToMatchups({ capt:w.capt, pdga:w.pdga, league:w.league, tc:w.tc, tiers:RANK_TIERS });
}

/* RESET menu: reset actions + weight presets */


/* (removed duplicate openResetMenu; combined into openRerankMenu) */


function setWeightsPreset(p){
  if (!p) return;

  document.getElementById('w-capt').value = p.capt;
  document.getElementById('w-pdga').value = p.pdga;
  document.getElementById('w-league').value = p.league;
  document.getElementById('w-tc').value = p.tc;

  localStorage.setItem('w-capt', p.capt);
  localStorage.setItem('w-pdga', p.pdga);
  localStorage.setItem('w-league', p.league);
  localStorage.setItem('w-tc', p.tc);

  calculateRankings();
}

function setDefaultWeights(){
  setWeightsPreset(DEFAULT_WEIGHTS);
}

function runResetDefaults(){
  setLoading(true);
  google.script.run
    .withSuccessHandler(()=>{
      fetchLatestRankingsAndRefresh(()=>{
        setLoading(false);
        showPopup("Success", "Defaults restored (PDGA/Ranks).", "#28a745");
      });
    })
    .withFailureHandler((err)=>{
      setLoading(false);
      const msg = (err && err.message) ? err.message : String(err || "Unknown error");
      showPopup("Error", msg, "#dc3545");
    })
    .resetAcesMatchupsToDefaults();
}


</script>
</body>
</html>
